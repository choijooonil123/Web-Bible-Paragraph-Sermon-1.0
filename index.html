<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web Bible â€“ Paragraph Sermon (Final Slim)</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#161922; --text:#e6e8ef; --muted:#9aa0ab;
      --accent:#6ea8fe; --border:#252a36; --danger:#ff6b6b; --titleBlue:#9fd0ff;
    }
    *{ box-sizing:border-box } html,body{ height:100% }
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
      background:var(--bg); color:var(--text);
      display:grid; grid-template-rows:64px 1fr; gap:10px;
    }
    header{
      display:flex; align-items:center; gap:10px; padding:8px 10px;
      background:var(--panel); border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:5;
    }
    header h1{ font-size:16px; margin:0; font-weight:700 }
    .muted{ color:var(--muted) }
    .pill{
      display:flex; gap:8px; align-items:center; border:1px solid var(--border);
      background:color-mix(in hsl, var(--panel) 80%, black 8%); padding:6px 8px; border-radius:10px;
    }
    select, input[type="range"]{ background:transparent; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:4px 6px }
    option{ color:#000 }
    button{
      background:color-mix(in hsl, var(--panel) 65%, black 10%); color:var(--text);
      border:1px solid var(--border); border-radius:10px; padding:6px 10px; cursor:pointer;
    }
    button:hover{ border-color:color-mix(in hsl, var(--border) 80%, var(--accent) 20%) }
    .primary{
      background:linear-gradient(180deg,color-mix(in srgb, var(--accent) 75%, white 10%), color-mix(in srgb, var(--accent) 75%, black 20%));
      border-color:color-mix(in srgb, var(--accent) 70%, black 10%);
    }

    .layout{ display:grid; grid-template-columns:1fr; gap:10px; padding:0 10px 12px }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:14px; overflow:hidden; display:flex; flex-direction:column; min-width:0 }
    .scroller{ overflow:auto; padding:12px }
    .footer{ padding:8px 12px; border-top:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap }

    #tree{ padding:8px }
    details{
      border:1px solid var(--border); border-radius:10px; padding:6px 8px; margin-bottom:8px;
      background:color-mix(in hsl, var(--panel) 80%, black 8%);
    }
    summary{ cursor:pointer; list-style:none; display:flex; align-items:center; gap:8px }
    summary::-webkit-details-marker{ display:none }
    .tw{ font-weight:700 }
    .chapters{ display:grid; gap:6px; margin-top:6px }
    .paras{ display:grid; gap:6px; margin:8px 0 2px }
    .chip{
      font-size:.92em; padding:6px 10px; border:1px solid var(--border); border-radius:999px;
      display:inline-flex; align-items:center; gap:6px; background:color-mix(in hsl, var(--panel) 88%, black 4%); white-space:nowrap;
    }
    .chip:hover{ border-color:var(--accent) }
    .ptitle{ font-weight:800; color:var(--titleBlue) }
    .vrange{ color:var(--muted); font-weight:700 }

    .pbody{ margin-top:8px; border-top:1px dashed var(--border); padding-top:8px }
    .ptoolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px }
    .pline{ padding:4px 6px; border-left:3px solid transparent; border-radius:8px; transition: background .15s, border-color .15s }
    .pline:hover{ background:color-mix(in hsl, var(--panel) 80%, black 12%) }
    .pline.reading{ background:color-mix(in hsl, var(--accent) 15%, black 0%); border-left-color:var(--accent) }
    .pv{ color:var(--muted); font-size:.88em; vertical-align:super; margin-right:4px }

    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50 }
    .modal{ width:min(1200px, 96vw); max-height:94vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:14px }
    .modal .head{
      position:sticky; top:0; background:var(--panel); padding:12px 14px;
      display:flex; gap:10px; align-items:center; border-bottom:1px solid var(--border)
    }
    .list{ padding:12px 14px; display:grid; gap:0 }
    .item{ border:1px solid var(--border); border-radius:10px; padding:2px 8px; display:flex; justify-content:space-between; align-items:center; gap:8px }
    .item-title{ font-weight:700; color:var(--titleBlue); line-height:1.15 }
    .item-title .date{ margin-left:8px; color:var(--muted); font-weight:400; font-size:.92em }

    .editor{ padding:14px; display:grid; gap:12px; background:var(--panel) }
    .editor input[type="text"], .editor textarea{ width:100%; background:#161922; color:#e6e8ef; border:1px solid #2a3040; border-radius:8px; padding:10px 12px }
    .editor textarea{ min-height:360px; resize:vertical }
    .thumbs{ display:flex; gap:8px; flex-wrap:wrap }
    .thumbs img{ width:112px; height:112px; object-fit:cover; border-radius:10px; border:1px solid var(--border) }
    .editor-bar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .editor-bar .grow{ flex:1 1 auto }
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   [ë§¥ë½ í¸ì§‘ê¸° ì „ìš©] ë³´ê¸° ì¢‹ì€ íƒ€ì´í¬/ë ˆì´ì•„ì›ƒ
   - openSingleDocEditor()ì—ì„œ sermonEditorì—
     class="context-editor" ë¥¼ ë¶™ì´ë©´ ì ìš©ë¨
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.context-editor {
  /* ëª…ì¡°ê³„(í•œêµ­ì–´) + ì˜ë¬¸ ì¡°í™” */
  font-family: "Noto Serif KR", "Nanum Myeongjo", serif;
  font-size: 1.05rem;
  line-height: 1.85;
  letter-spacing: 0.02em;
  word-break: keep-all;

  /* ì¹´ë“œ í†¤ ìœ ì§€ + ì‚´ì§ ë” ì…ì²´ê° */
  background: var(--panel);
  color: var(--text);
  border-radius: 12px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.25);
}

/* ì œëª© ì…ë ¥ */
.context-editor input[type="text"]{
  font-family: "Noto Serif KR", "Nanum Myeongjo", serif;
  font-weight: 600;
  font-size: 1.12rem;
  letter-spacing: 0.01em;
}

/* ë³¸ë¬¸ ì…ë ¥ */
.context-editor textarea{
  font-family: "Noto Serif KR", "Nanum Myeongjo", serif;
  line-height: 1.9;
  letter-spacing: 0.015em;
  min-height: 420px; /* ê¸°ì¡´ë³´ë‹¤ ì•½ê°„ ë„‰ë„‰íˆ */
  caret-color: var(--accent);
}

/* ê°•ì¡° ëŠë‚Œ */
.context-editor em,
.context-editor strong,
.context-editor b{
  color: #ffd66e;
  font-weight: 600;
  font-style: normal;
}

/* ì¸ìš© ëŠë‚Œ(ë¶™ì—¬ ë„£ê¸° ì‹œ blockquote ë Œë” ëŒ€ë¹„) */
.context-editor blockquote{
  margin: 12px 0;
  padding: 10px 14px;
  border-left: 3px solid var(--accent);
  color: #c0cad6;
  font-style: italic;
  background: rgba(255,255,255,0.04);
  border-radius: 8px;
}

/* ì„ íƒ ì˜ì—­ ìƒ‰ê° */
.context-editor ::selection{
  background: rgba(110,168,254,0.25);
}

/* ëª¨ë°”ì¼ ë¯¸ì„¸ ì¡°ì • */
@media (max-width:640px){
  .context-editor{ font-size: 1rem; }
}

/* ë¼ì´íŠ¸ ëª¨ë“œ ëŒ€ë¹„ */
@media (prefers-color-scheme: light){
  .context-editor{
    color: #1b2533;
    background: #fff;
    box-shadow: 0 6px 16px rgba(0,0,0,0.08);
  }
  .context-editor blockquote{
    color: #445066;
    background: #f7f9fc;
  }
}

/* [ë§¥ë½ í¸ì§‘ê¸° ì „ìš©] */
.context-editor{font-family:"Noto Serif KR","Nanum Myeongjo",serif;font-size:1.05rem;line-height:1.85;letter-spacing:.02em;word-break:keep-all;background:var(--panel);color:var(--text);border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.25)}
.context-editor input[type="text"]{font-family:"Noto Serif KR","Nanum Myeongjo",serif;font-weight:600;font-size:1.12rem;letter-spacing:.01em}
.context-editor textarea{font-family:"Noto Serif KR","Nanum Myeongjo",serif;line-height:1.9;letter-spacing:.015em;min-height:420px;caret-color:var(--accent)}
.context-editor em,.context-editor strong,.context-editor b{color:#ffd66e;font-weight:600;font-style:normal}
.context-editor blockquote{margin:12px 0;padding:10px 14px;border-left:3px solid var(--accent);color:#c0cad6;font-style:italic;background:rgba(255,255,255,.04);border-radius:8px}
.context-editor ::selection{background:rgba(110,168,254,.25)}
@media (max-width:640px){.context-editor{font-size:1rem}}
@media (prefers-color-scheme:light){.context-editor{color:#1b2533;background:#fff;box-shadow:0 6px 16px rgba(0,0,0,.08)}.context-editor blockquote{color:#445066;background:#f7f9fc}}

    
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600&family=Nanum+Myeongjo&display=swap" rel="stylesheet">
</head>

<body>
  <header>
    <h1>Web Bible â€“ Paragraph Sermon</h1>

    <div class="pill">
      <button id="btnSaveJSON">JSON ì €ì¥</button>
    </div>


    <div class="pill">
      <button id="btnExportAll">ë‚´ë³´ë‚´ê¸°</button>
      <input id="importFile" type="file" accept="application/json" style="display:none">
      <button id="btnImportAll">ê°€ì ¸ì˜¤ê¸°</button>
    </div>


    <div class="pill">
      <span class="muted">ìŒì„±</span>
      <select id="voiceSelect" title="í•œêµ­ì–´ ë³´ì´ìŠ¤ ì„ íƒ">
        <option value="">ë¸Œë¼ìš°ì € ê¸°ë³¸(ko-KR)</option>
      </select>
      <button id="testVoice">ì‹œí—˜</button>
    </div>

    <div class="pill">
      <span class="muted">ì†ë„</span>
      <input id="rateCtl" type="range" min="0.6" max="1.4" step="0.02" value="0.95" />
      <span class="muted">í†¤</span>
      <input id="pitchCtl" type="range" min="0.6" max="1.4" step="0.02" value="1.00" />
    </div>

    <div class="pill" id="voiceHint" style="display:none">
      <span class="muted">í•œêµ­ì–´ ë³´ì´ìŠ¤ê°€ 1ê°œë¿ì´ë¼ ìŠ¤íƒ€ì¼ í”„ë¦¬ì…‹ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.</span>
    </div>

    <div style="flex:1"></div>
    <div class="pill"><span class="muted">ë‹¨ì¶•í‚¤:</span> <span> S</span> ì¬ìƒ/ì¤‘ì§€ <span> Â· N</span> ë‹¤ìŒ ë‹¨ë½</div>
  </header>

  <div class="layout">
    <section class="card">
      <div class="scroller"><div id="tree"></div></div>
      <div class="footer"><div class="muted" id="status">bible-paragraph.jsonì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div></div>
    </section>
  </div>

  <div id="modalWrap" class="modal-backdrop" aria-hidden="true">
    <div class="modal">
      <div class="head">
        <strong>ë‹¨ë½ ì„¤êµ</strong>
        <span class="muted" id="modalRef">â€”</span>
        <div class="grow"></div>
        <button id="closeModal">ë‹«ê¸°</button>
      </div>

      <div class="list" id="sermonList"></div>

      <div class="editor" id="sermonEditor" style="display:none">
        <input type="text" id="sermonTitle" placeholder="ì œëª©" />
        <textarea id="sermonBody" placeholder="ë‚´ìš©"></textarea>
        <div class="editor-bar">
          <input type="file" id="sermonImages" accept="image/*" multiple />
          <div class="grow"></div>
          <button id="editorSpeak" class="primary">ë‚­ë…</button>
          <button id="saveSermon" class="primary">ì €ì¥</button>
          <button id="cancelEdit">ì·¨ì†Œ</button>
        </div>
        <div class="thumbs" id="sermonThumbs"></div>
      </div>

      <div id="modalFooterNew" class="footer" style="padding:10px 14px; border-top:1px solid var(--border)">
        <button id="newSermonBtn" class="primary">ìƒˆ ì„¤êµ</button>
      </div>
    </div>
  </div>

  <script>
    /* --------- Utils --------- */

function syncCurrentFromOpen(){
  const openPara = treeEl.querySelector('details.para[open]');
  if(!openPara) return false;

  const t = openPara.querySelector('summary .ptitle');
  if(!t) return false;

  const book = t.dataset.book;
  const chap = parseInt(t.dataset.ch, 10);
  const idx  = parseInt(t.dataset.idx, 10);

  const para = BIBLE?.books?.[book]?.[chap]?.paras?.[idx];
  if(!para) return false;

  CURRENT.book   = book;
  CURRENT.chap   = chap;
  CURRENT.paraIdx= idx;
  CURRENT.paraId = `${book}|${chap}|${para.ref}`;
  return true;
}
    
    const el = id => document.getElementById(id);
    function status(msg){ statusEl.textContent = msg; }
    function escapeHtml(s){ return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
    function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
    function stripBlankLines(s){return String(s||'').split(/\r?\n/).filter(l=>l.trim()!=='').join('\n');}

    
    // ==== ì¸ë¼ì¸ ì œëª© í¸ì§‘ ====
    function startInlineTitleEdit(el, book, chap, idx){
      const old = el.textContent.trim();
      el.setAttribute('contenteditable','plaintext-only');
      el.spellcheck = false;
      el.classList.add('editing');
      el.focus();
      const sel = window.getSelection();
      const range = document.createRange();
      range.selectNodeContents(el);
      sel.removeAllRanges(); sel.addRange(range);

      function finish(commit){
        el.removeAttribute('contenteditable');
        el.classList.remove('editing');
        document.removeEventListener('keydown', onKey, true);
        el.removeEventListener('blur', onBlur);
        if(commit){
          const newTitle = el.textContent.trim() || '(ì œëª© ì—†ìŒ)';
          updateParaTitle(book, chap, idx, newTitle);
          status('ë‹¨ë½ ì œëª©ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. (Ctrl+Shift+Së¡œ JSON ì €ì¥ ê°€ëŠ¥)');
        }else{
          el.textContent = old;
          status('ì œëª© í¸ì§‘ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
      }
      function onKey(e){
        if(e.key === 'Enter'){ e.preventDefault(); finish(true); }
        if(e.key === 'Escape'){ e.preventDefault(); finish(false); }
      }
      function onBlur(){ finish(true); }
      document.addEventListener('keydown', onKey, true);
      el.addEventListener('blur', onBlur);
    }

    // ë©”ëª¨ë¦¬(BIBLE) ë°ì´í„° ê°±ì‹ 
    function updateParaTitle(book, chap, idx, newTitle){
      try{
        const para = BIBLE?.books?.[book]?.[chap]?.paras?.[idx];
        if(!para) return;
        para.title = newTitle;
    
        // ì—¬ê¸°ì„œ ch â†’ chap ë¡œ ìˆ˜ì •
        const s = document.querySelector(
          `summary .ptitle[data-book="${CSS.escape(String(book))}"][data-ch="${CSS.escape(String(chap))}"][data-idx="${CSS.escape(String(idx))}"]`
        );
        if(s) s.textContent = newTitle;
      }catch(_){}
    }


    // ==== JSON ë‚´ë³´ë‚´ê¸°(ë³¸ë¬¸) ====
    function downloadBibleJSON(){
      if(!BIBLE){ alert('BIBLE ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const blob = new Blob([JSON.stringify(BIBLE, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'bible-paragraphs.json';
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
      status('ìˆ˜ì •ëœ JSONì„ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.');
    }

    /* ==== (ì‹ ê·œ) ì „ì²´ ë°ì´í„° ë°±ì—…/ë³µì› - ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸° ì „ìš© ì½”ë“œ ==== */
    // localStorage í‚¤ë“¤
    const STORAGE_SERMON      = 'wbps.sermons.v4';
    const STORAGE_UNIT_CTX    = 'wbps.ctx.unit.v1';
    const STORAGE_WHOLE_CTX   = 'wbps.ctx.whole.v1';
    const STORAGE_COMMENTARY  = 'wbps.ctx.comm.v1';
    const STORAGE_SUMMARY     = 'wbps.ctx.summary.v1';
    const VOICE_CHOICE_KEY    = 'wbps.tts.choice.v2';

    function todayStr(){
      const d=new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    function exportAllData(){
      const keys = [
        STORAGE_SERMON, STORAGE_UNIT_CTX, STORAGE_WHOLE_CTX,
        STORAGE_COMMENTARY, STORAGE_SUMMARY, VOICE_CHOICE_KEY
      ];
      const payload = { __wbps:1, date: todayStr(), items:{} };
      keys.forEach(k=> payload.items[k] = localStorage.getItem(k) ?? null);

      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      const ts = new Date();
      const tss = `${ts.getFullYear()}${String(ts.getMonth()+1).padStart(2,'0')}${String(ts.getDate()).padStart(2,'0')}-${String(ts.getHours()).padStart(2,'0')}${String(ts.getMinutes()).padStart(2,'0')}`;
      a.href = URL.createObjectURL(blob);
      a.download = `wbps-backup-${tss}.json`;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
      status('ì „ì²´ ë°ì´í„°ë¥¼ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.');
    }

    async function importAllData(file){
      try{
        const text = await file.text();
        const json = JSON.parse(text);
        if(!json || json.__wbps!==1 || !json.items){
          alert('ë°±ì—… íŒŒì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.'); return;
        }
        if(!confirm('ì´ ë°±ì—…ìœ¼ë¡œ í˜„ì¬ ê¸°ê¸°ì˜ ë°ì´í„°ë¥¼ ë®ì–´ì“¸ê¹Œìš”?')) return;

        Object.entries(json.items).forEach(([k,v])=>{
          if(v===null || v===undefined) localStorage.removeItem(k);
          else localStorage.setItem(k, v);
        });

        status('ê°€ì ¸ì˜¤ê¸°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ë°˜ì˜ë©ë‹ˆë‹¤.');
      }catch(e){
        console.error(e);
        alert('ê°€ì ¸ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    /* ==== ë ==== */

    /* --------- Refs --------- */
    const treeEl = el('tree'), statusEl = el('status');
    const voiceSelect = el('voiceSelect'), testVoiceBtn = el('testVoice');
    const rateCtl = el('rateCtl'), pitchCtl = el('pitchCtl'), voiceHint = el('voiceHint');
    const modalWrap = el('modalWrap'), modalRef = el('modalRef');
    const sermonList = el('sermonList'), sermonEditor = el('sermonEditor');
    const sermonTitle = el('sermonTitle'), sermonBody = el('sermonBody');
    sermonBody.addEventListener('blur',()=>{sermonBody.value=stripBlankLines(sermonBody.value);});
    sermonBody.addEventListener('paste',()=>{setTimeout(()=>{sermonBody.value=stripBlankLines(sermonBody.value);},0);});
    const sermonThumbs = el('sermonThumbs'), sermonImages = el('sermonImages');
    const editorSpeakBtn = el('editorSpeak');
    const modalFooterNew = el('modalFooterNew');

    let BIBLE = null;
    let CURRENT = { book:null, chap:null, paraIdx:null, paraId:null };
    let READER = { playing:false, q:[], idx:0, synth:window.speechSynthesis||null, scope:null, btn:null, continuous:false, forced:false };
    let EDITOR_READER = { playing:false, u:null, synth:window.speechSynthesis||null };

    /* --------- Boot --------- */
    (async function boot(){
      try{
        BIBLE = await tryFetchJSON('bible-paragraph.json');
      }catch(_){
        try{ BIBLE = await tryFetchJSON('bible_paragraphs.json'); }
        catch(e){ status('bible-paragraph.jsonì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê°™ì€ í´ë”ì— ë‘ê³  ë‹¤ì‹œ ì—´ì–´ì£¼ì„¸ìš”.'); return; }
      }
      buildTree();
      status('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ. 66ê¶Œ íŠ¸ë¦¬ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      await setupVoices();
    })();

    // ë²„íŠ¼ ë°”ì¸ë”© (ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸° í¬í•¨)
    (function bindButtons(){
      const btnSaveJSON = document.getElementById('btnSaveJSON');
      if (btnSaveJSON) btnSaveJSON.addEventListener('click', downloadBibleJSON);

      const btnExport = document.getElementById('btnExportAll');
      const btnImport = document.getElementById('btnImportAll');
      const fileInput = document.getElementById('importFile');

      if (btnExport) btnExport.onclick = exportAllData;
      if (btnImport) btnImport.onclick = ()=> fileInput && fileInput.click();
      if (fileInput) fileInput.addEventListener('change', (e)=>{
        const f = e.target.files?.[0]; if(!f) return;
        importAllData(f).finally(()=>{ e.target.value=''; });
      });
    })();

    async function tryFetchJSON(path){ const res = await fetch(path, {cache:'no-store'}); if(!res.ok) throw 0; return await res.json(); }

    /* --------- Voice --------- */
    function waitForVoices(timeout=1500){
      return new Promise(resolve=>{
        const have = speechSynthesis.getVoices?.();
        if (have && have.length) return resolve(have);
        const t = setTimeout(()=> resolve(speechSynthesis.getVoices?.()||[]), timeout);
        speechSynthesis.onvoiceschanged = ()=>{ clearTimeout(t); resolve(speechSynthesis.getVoices?.()||[]); };
      });
    }
    function getKoreanVoices(all){
      return (all||[]).filter(v=>{
        const n=(v.name||'').toLowerCase(), l=(v.lang||'').toLowerCase();
        return l.startsWith('ko') || n.includes('korean') || n.includes('í•œêµ­') || n.includes('korea');
      });
    }
    function presetsForSingleVoice(){
      return [
        {id:'preset-soft-low',  label:'í”„ë¦¬ì…‹ Â· ì €ìŒ/ëŠë¦¼',   rate:0.85, pitch:0.85},
        {id:'preset-soft-high', label:'í”„ë¦¬ì…‹ Â· ê³ ìŒ/ëŠë¦¼',   rate:0.90, pitch:1.20},
        {id:'preset-fast',      label:'í”„ë¦¬ì…‹ Â· ë¹ ë¦„',       rate:1.20, pitch:1.05},
        {id:'preset-bright',    label:'í”„ë¦¬ì…‹ Â· ë°ê²Œ',       rate:1.05, pitch:1.25},
        {id:'preset-radio',     label:'í”„ë¦¬ì…‹ Â· ë¼ë””ì˜¤í†¤',   rate:1.00, pitch:0.90},
        {id:'preset-reading',   label:'í”„ë¦¬ì…‹ Â· ë‚­ë…ì²´',     rate:0.95, pitch:1.00},
      ];
    }
    async function setupVoices(){
      const all = await waitForVoices();
      const kos = getKoreanVoices(all);

      voiceSelect.innerHTML = '';
      const def = document.createElement('option');
      def.value = JSON.stringify({type:'default'});
      def.textContent = 'ë¸Œë¼ìš°ì € ê¸°ë³¸(ko-KR)';
      voiceSelect.appendChild(def);

      if(kos.length > 0){
        const og = document.createElement('optgroup'); og.label = 'í•œêµ­ì–´ ë³´ì´ìŠ¤';
        kos.forEach(v=>{
          const opt = document.createElement('option');
          opt.value = JSON.stringify({type:'voice', uri:v.voiceURI});
          opt.textContent = `${v.name} â€” ${v.lang}${v.localService ? ' (ë¡œì»¬)' : ''}`;
          og.appendChild(opt);
        });
        voiceSelect.appendChild(og);
      }
      if(kos.length <= 1){
        const pg = document.createElement('optgroup'); pg.label = 'ìŠ¤íƒ€ì¼ í”„ë¦¬ì…‹';
        presetsForSingleVoice().forEach(p=>{
          const opt = document.createElement('option');
          opt.value = JSON.stringify({type:'preset', rate:p.rate, pitch:p.pitch});
          opt.textContent = p.label;
          pg.appendChild(opt);
        });
        voiceHint.style.display = '';
      } else {
        voiceHint.style.display = 'none';
      }

      const saved = localStorage.getItem(VOICE_CHOICE_KEY);
      if(saved){
        const idx = [...voiceSelect.options].findIndex(o=>o.value===saved);
        if(idx>=0) voiceSelect.selectedIndex = idx;
      } else {
        localStorage.setItem(VOICE_CHOICE_KEY, voiceSelect.value);
      }
      voiceSelect.addEventListener('change', ()=> localStorage.setItem(VOICE_CHOICE_KEY, voiceSelect.value));
      testVoiceBtn.onclick = ()=> speakSample('íƒœì´ˆì— í•˜ë‚˜ë‹˜ì´ ì²œì§€ë¥¼ ì°½ì¡°í•˜ì‹œë‹ˆë¼.');
    }
    function resolveVoiceChoice(){
      try{ return JSON.parse(localStorage.getItem(VOICE_CHOICE_KEY)||'{"type":"default"}'); }
      catch{ return {type:'default'}; }
    }
    function pickVoiceByURI(uri){ return (speechSynthesis.getVoices?.()||[]).find(v=>v.voiceURI===uri) || null; }
    function applyVoice(u){
      const choice = resolveVoiceChoice();
      const baseRate = parseFloat(rateCtl.value||'0.95');
      const basePitch = parseFloat(pitchCtl.value||'1');
      if(choice.type==='voice'){
        const v = pickVoiceByURI(choice.uri);
        if(v){ u.voice = v; u.lang = v.lang; } else { u.lang = 'ko-KR'; }
        u.rate = baseRate; u.pitch = basePitch;
      } else if(choice.type==='preset'){
        u.lang = 'ko-KR';
        u.rate = clamp((choice.rate ?? 0.95) * baseRate / 0.95, 0.5, 2);
        u.pitch = clamp((choice.pitch ?? 1.0) * basePitch / 1.0, 0, 2);
      } else {
        u.lang = 'ko-KR'; u.rate = baseRate; u.pitch = basePitch;
      }
    }
    function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
    function speakSample(text){
      const synth = window.speechSynthesis;
      try{ synth.cancel(); }catch(e){}
      const u = new SpeechSynthesisUtterance(text);
      applyVoice(u);
      synth.speak(u);
    }

    /* --------- Tree --------- */
    function buildTree(){
      treeEl.innerHTML = '';
      if(!BIBLE){ treeEl.innerHTML = '<div class="muted">íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

      for(const bookName of Object.keys(BIBLE.books)){
        const detBook = document.createElement('details');
        const sumBook = document.createElement('summary');
        sumBook.innerHTML = `<span class="tw">${escapeHtml(bookName)}</span>`;
        detBook.appendChild(sumBook);

        const chWrap = document.createElement('div'); chWrap.className='chapters';
        const chapters = Object.keys(BIBLE.books[bookName]).map(n=>parseInt(n,10)).sort((a,b)=>a-b);

        for(const ch of chapters){
          const detChap = document.createElement('details');
          const sumChap = document.createElement('summary');
          sumChap.innerHTML = `<span class="chip">${ch}ì¥</span>`;
          detChap.appendChild(sumChap);

          const parWrap = document.createElement('div'); parWrap.className='paras';
          const paras = BIBLE.books[bookName][ch].paras || [];
          paras.forEach((p, idx)=>{
            const detPara = document.createElement('details'); detPara.className='para';

            const m = String(p.ref||'').match(/^(\d+):(\d+)(?:-(\d+))?$/);
            const v1 = m ? m[2] : '?', v2 = m ? (m[3]||m[2]) : '?';
            const titleText = p.title || p.ref;

            const sum = document.createElement('summary');
            sum.innerHTML = `
              <span class="vrange">(${v1}-${v2})</span>
              <span class="ptitle"
                    data-book="${bookName}"
                    data-ch="${ch}"
                    data-idx="${idx}"
                    title="ì œëª©ì„ ë”ë¸”í´ë¦­í•˜ë©´ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤">${escapeHtml(titleText)}</span>
            `;

            const titleEl = sum.querySelector('.ptitle');

            titleEl.addEventListener('dblclick', (e)=>{
              e.preventDefault(); e.stopPropagation();
              detPara.open = true;
              startInlineTitleEdit(titleEl, bookName, ch, idx);
            }, true);

            function guardSummary(ev){
              const isEditing = titleEl.isContentEditable;
              const dblOnTitle = (ev.type === 'dblclick' && ev.target === titleEl);
              if (isEditing || dblOnTitle){
                ev.preventDefault();
                ev.stopPropagation();
              }
            }
            ['pointerdown','mousedown','click','dblclick'].forEach(type=>{
              sum.addEventListener(type, guardSummary, true);
            });

            detPara.appendChild(sum);

            const body = document.createElement('div');
            body.className = 'pbody';
            body.innerHTML = `
              <div class="ptoolbar">
                <button class="primary speakBtn">ë‚­ë…</button>
                <label class="chip"><input type="checkbox" class="keepReading" style="margin-right:6px">ê³„ì† ë‚­ë…</label>
                <button class="ctxBtn btnUnitCtx">ë‹¨ìœ„ì„±ê²½ì† ë§¥ë½</button>
                <button class="ctxBtn btnWholeCtx">ì „ì²´ì„±ê²½ì† ë§¥ë½</button>
                <button class="ctxBtn btnCommentary">ì£¼ì„</button>
                <button class="ctxBtn btnSummary">ë‚´ìš©ìš”ì•½</button>
                <div class="spacer"></div>
                <button class="sermBtn">ì„¤êµ</button>
              </div>
              <div class="pcontent"></div>`;
            detPara.appendChild(body);

            const pcontent = body.querySelector('.pcontent');
            (p.verses||[]).forEach(([v,t])=>{
              const line = document.createElement('div');
              line.className = 'pline';
              line.dataset.verse = v;
              line.innerHTML = `<sup class="pv">${v}</sup>${t}`;
              pcontent.appendChild(line);
            });

            detPara.addEventListener('toggle', ()=>{
              if(detPara.open){
                CURRENT.book = bookName; CURRENT.chap = ch; CURRENT.paraIdx = idx;
                const para = BIBLE.books[bookName][ch].paras[idx];
                CURRENT.paraId = `${bookName}|${ch}|${para.ref}`;
                status(`ì„ íƒë¨: ${bookName} ${ch}ì¥ Â· ${para.title||para.ref}`);
              }
            });

            body.querySelector('.speakBtn').addEventListener('click', ()=>{
              toggleSpeakInline(bookName, ch, idx, detPara, body.querySelector('.speakBtn'));
            });
            body.querySelector('.sermBtn').addEventListener('click', ()=>{
              CURRENT.book = bookName; CURRENT.chap = ch; CURRENT.paraIdx = idx;
              const para = BIBLE.books[bookName][ch].paras[idx];
              CURRENT.paraId = `${bookName}|${ch}|${para.ref}`;
              openSermonModal();
            });
            body.querySelector('.btnUnitCtx').addEventListener('click', ()=>{ CURRENT.book=bookName; CURRENT.chap=ch; CURRENT.paraIdx=idx; openSingleDocEditor('unit'); });
            body.querySelector('.btnWholeCtx').addEventListener('click',()=>{ CURRENT.book=bookName; CURRENT.chap=ch; CURRENT.paraIdx=idx; openSingleDocEditor('whole'); });
            body.querySelector('.btnCommentary').addEventListener('click',()=>{ CURRENT.book=bookName; CURRENT.chap=ch; CURRENT.paraIdx=idx; openSingleDocEditor('commentary'); });
            body.querySelector('.btnSummary').addEventListener('click',   ()=>{ CURRENT.book=bookName; CURRENT.chap=ch; CURRENT.paraIdx=idx; openSingleDocEditor('summary'); });

            parWrap.appendChild(detPara);
          });

          detChap.appendChild(parWrap);
          chWrap.appendChild(detChap);
        }

        detBook.appendChild(chWrap);
        treeEl.appendChild(detBook);
      }
    }

    /* --------- Inline TTS --------- */
    function buildQueueFrom(book, chap, idx){
      const para = BIBLE.books[book][chap].paras[idx];
      return (para.verses||[]).map(([v,t])=>({verse:v, text:t}));
    }
    function clearReadingHighlight(scope){ [...scope.querySelectorAll('.pline')].forEach(el=> el.classList.remove('reading')); }
    function bindKeepReading(scope){
      const cb = scope.querySelector('.keepReading');
      if(!cb) return;
      cb.checked  = READER.continuous;
      cb.disabled = !!READER.forced; // ê°•ì œ ëª¨ë“œì¼ ë• ë¹„í™œì„±í™”
      cb.onchange = ()=>{
        if(READER.forced){ // ê°•ì œ ëª¨ë“œì—ì„œëŠ” ì‚¬ìš©ìì˜ í† ê¸€ì„ ë¬´ì‹œ
          cb.checked = true;
          return;
        }
        READER.continuous = cb.checked;
      };
    }

    function speakVerseItemInScope(item, scope, onend){
      if(!READER.synth) return;
    
      const u = new SpeechSynthesisUtterance(String(item.text));
      applyVoice(u);
    
      // onendê°€ ë“œë¬¼ê²Œ ì•ˆ ë“¤ì–´ì˜¤ëŠ” í¬ë¡¬/OS ë²„ê·¸ ëŒ€ë¹„: ì•ˆì „ ì¢…ë£Œ í”Œë˜ê·¸ + íƒ€ì´ë¨¸
      let done = false;
      const safeEnd = ()=>{ if(done) return; done = true; onend(); };
    
      u.onstart = ()=>{
        clearReadingHighlight(scope);
        const line = scope.querySelector(`.pline[data-verse="${item.verse}"]`);
        if(line){ line.classList.add('reading'); line.scrollIntoView({block:'center', behavior:'smooth'}); }
        // ì‹œì‘ ì‹œ ì´ì „ ì›Œì¹˜ë… ì œê±°
        if (READER._wd){ clearTimeout(READER._wd); READER._wd = null; }
        // ëŒ€ëµ ê¸¸ì´ì— ë¹„ë¡€í•´ ì¢…ë£Œ ë³´ì¡° íƒ€ì´ë¨¸ ì„¤ì • (ë¬¸ìë‹¹ 65ms ê¸°ì¤€, ìµœì†Œ 800ms)
        const base = Math.max(800, Math.round(item.text.length * 65));
        // rateê°€ ë¹ ë¥´ë©´ ì‹¤ì œ ì¬ìƒì‹œê°„ì´ ì§§ìœ¼ë¯€ë¡œ ë³´ì •
        const rate = u.rate || 1;
        const estimate = Math.max(600, Math.round(base / rate)) + 1200;
        READER._wd = setTimeout(safeEnd, estimate);
      };
      u.onend   = safeEnd;
      u.onerror = safeEnd;
    
      READER.synth.speak(u);
    }

function toggleSpeakInline(book, chap, idx, paraDetailsEl, btnEl){
    if(!READER.synth) return alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±í•©ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    const sameScope = READER.playing && READER.scope === paraDetailsEl;
    if(READER.playing && sameScope){ stopSpeakInline(); return; }
    
    // â˜… ê°•ì œ ì´ì–´ì½ê¸° ëª¨ë“œë¡œ ì§„ì…
    READER.forced = true;
    READER.continuous = true; // ì²´í¬ë°•ìŠ¤ì™€ ë¬´ê´€í•˜ê²Œ ì¼ ë‹¤
    
    READER.q = buildQueueFrom(book, chap, idx);
    READER.idx = 0;
    READER.playing = true;
    READER.scope = paraDetailsEl;
    READER.btn = btnEl;
    
    try{ READER.synth.cancel(); }catch(e){}
    
    // ì²´í¬ë°•ìŠ¤ UIë¥¼ ê°•ì œ ëª¨ë“œ/ìƒíƒœì— ë§ì¶° ë™ê¸°í™”
    bindKeepReading(READER.scope);
    updateInlineSpeakBtn();
    playNextInQueueInline(book, chap, idx);

}


function playNextInQueueInline(book, chap, idx){
  if(!READER.playing) return;

  // ë‹¨ë½ ë
  if(READER.idx >= READER.q.length){
    // ê³„ì† ë‚­ë… ì¼œì ¸ ìˆìœ¼ë©´ ë‹¤ìŒ ë‹¨ë½ ìë™ ì´ë™
    if(READER.continuous && goToNextParagraphInline(book, chap, idx)){
      // === ìƒˆ ë‹¨ë½ ë„ì°© ===
      // ìƒˆ ë‹¨ë½ì˜ ë¡œì»¬ ì²´í¬ ìƒíƒœë¡œ ê°±ì‹ 
      // (êµì²´) ì „ì—­ continuous ìœ ì§€, UIë§Œ ë°˜ì˜
      // === ìƒˆ ë‹¨ë½ ë„ì°© ===
      // ì „ì—­ continuous ìœ ì§€ + ìƒˆ ë‹¨ë½ ì²´í¬ UIë§Œ ë°˜ì˜(+ê°•ì œ ëª¨ë“œë©´ ë¹„í™œì„±)
      const nextCb = READER.scope?.querySelector?.('.keepReading');
      if(nextCb){
        nextCb.checked  = READER.continuous;
        nextCb.disabled = !!READER.forced; // â˜… ê°•ì œ ëª¨ë“œë©´ ë¹„í™œì„±
      }
      
      // ìƒˆ ë‹¨ë½ ê¸°ì¤€ìœ¼ë¡œ í ì¬ë¹Œë“œ
      READER.q = buildQueueFrom(CURRENT.book, CURRENT.chap, CURRENT.paraIdx);
      READER.idx = 0;
      
      // ìƒˆ ë‹¨ë½ UI ë™ê¸°í™”
      bindKeepReading(READER.scope);
      updateInlineSpeakBtn();


      // í¬ë¡¬ onend ì§í›„ speak ë¬´ì‹œ ë°©ì§€
      setTimeout(()=>{
        try{ READER.synth.cancel(); }catch(e){}
        playNextInQueueInline(CURRENT.book, CURRENT.chap, CURRENT.paraIdx);
      }, 120);
      return;
    }
    // ê³„ì† ë‚­ë…ì´ êº¼ì ¸ ìˆê±°ë‚˜ ë” ì´ìƒ ì´ë™ ë¶ˆê°€
    stopSpeakInline();
    return;
  }

  // ê°™ì€ ë‹¨ë½ ë‚´ ë‹¤ìŒ êµ¬ì ˆ ì¬ìƒ
  const item = READER.q[READER.idx];
  speakVerseItemInScope(item, READER.scope, ()=>{
    READER.idx++;
    playNextInQueueInline(book, chap, idx);
  });
}


function stopSpeakInline(){
  READER.playing = false;
  READER.forced  = false; // â˜… ê°•ì œ ëª¨ë“œ í•´ì œ
  try{ READER.synth && READER.synth.cancel(); }catch(e){}
  if (READER._wd){ clearTimeout(READER._wd); READER._wd = null; }

  // ì²´í¬ë°•ìŠ¤ UI ë³µêµ¬ (ê°€ëŠ¥í•˜ë©´)
  if(READER.scope){
    const cb = READER.scope.querySelector?.('.keepReading');
    if(cb) cb.disabled = false;
    clearReadingHighlight(READER.scope);
  }

  updateInlineSpeakBtn();
  READER.scope = null; READER.btn = null;
}


    function updateInlineSpeakBtn(){ if(READER.btn) READER.btn.textContent = READER.playing ? 'ì¤‘ì§€' : 'ë‚­ë…'; }

function goToNextParagraphInline(book, chap, idx){
  const chObj = BIBLE.books[book][chap];

  const booksEls = [...treeEl.children];
  const bIdx = Object.keys(BIBLE.books).indexOf(book);
  const bookEl = booksEls[bIdx]; if(!bookEl) return false;

  const chaptersEls = bookEl.querySelectorAll(':scope > .chapters > details');
  const chapNums = Object.keys(BIBLE.books[book]).map(n=>parseInt(n,10)).sort((a,b)=>a-b);
  const chPos = chapNums.indexOf(ch);
  const chapEl = chaptersEls[chPos]; if(!chapEl) return false;

  const paraEls = chapEl.querySelectorAll(':scope > .paras > details.para');

  // ì´ì „ ë‹¨ë½ ë²„íŠ¼ ë¼ë²¨ ë³µêµ¬
  if (READER.btn) READER.btn.textContent = 'ë‚­ë…';

  // ê°™ì€ ì¥ì˜ ë‹¤ìŒ ë‹¨ë½
  if(idx < chObj.paras.length-1){
    const nextEl = paraEls[idx+1];
    if(nextEl){
      chapEl.open = true; nextEl.open = true;
      CURRENT.book = book; CURRENT.chap = chap; CURRENT.paraIdx = idx+1;
      READER.scope = nextEl;
      READER.btn = nextEl.querySelector('.speakBtn');
      if (READER.btn) READER.btn.textContent = READER.playing ? 'ì¤‘ì§€' : 'ë‚­ë…';
      return true;
    }
  }

  // ë‹¤ìŒ ì¥ ì²« ë‹¨ë½
  if(chPos >= 0 && chPos < chapNums.length-1){
    const nextChap = chapNums[chPos+1];
    const nextChapEl = chaptersEls[chPos+1];
    if(nextChapEl){
      const nextParas = BIBLE.books[book][nextChap].paras||[];
      if(nextParas.length){
        const nextParaEl = nextChapEl.querySelector(':scope > .paras > details.para');
        nextChapEl.open = true; if(nextParaEl) nextParaEl.open = true;
        CURRENT.book = book; CURRENT.chap = nextChap; CURRENT.paraIdx = 0;
        READER.scope = nextParaEl;
        READER.btn = nextParaEl?.querySelector('.speakBtn') || null;
        if (READER.btn) READER.btn.textContent = READER.playing ? 'ì¤‘ì§€' : 'ë‚­ë…';
        return true;
      }
    }
  }

  // ë‹¤ìŒ ì±… ì²« ì¥ ì²« ë‹¨ë½
  const bookNames = Object.keys(BIBLE.books);
  const bPos = bookNames.indexOf(book);
  if(bPos >= 0 && bPos < bookNames.length-1){
    const nextBook = bookNames[bPos+1];
    const nextBookEl = booksEls[bPos+1];
    if(nextBookEl){
      const firstChap = Math.min(...Object.keys(BIBLE.books[nextBook]).map(n=>parseInt(n,10)));
      const nextChapEl = nextBookEl.querySelector(':scope > .chapters > details');
      const nextParaEl = nextChapEl?.querySelector(':scope > .paras > details.para');
      if(nextParaEl){
        nextBookEl.open = true; nextChapEl.open = true; nextParaEl.open = true;
        CURRENT.book = nextBook; CURRENT.chap = firstChap; CURRENT.paraIdx = 0;
        READER.scope = nextParaEl;
        READER.btn = nextParaEl.querySelector('.speakBtn');
        if (READER.btn) READER.btn.textContent = READER.playing ? 'ì¤‘ì§€' : 'ë‚­ë…';
        return true;
      }
    }
  }
  return false;
}

    /* --------- Sermon / Context Editors --------- */
    function getSermonMap(){ try{ return JSON.parse(localStorage.getItem(STORAGE_SERMON)||'{}'); }catch{ return {}; } }
    function setSermonMap(o){ localStorage.setItem(STORAGE_SERMON, JSON.stringify(o)); }
    function getDocMap(storageKey){ try{ return JSON.parse(localStorage.getItem(storageKey)||'{}'); }catch{ return {}; } }
    function setDocMap(storageKey, obj){ localStorage.setItem(storageKey, JSON.stringify(obj)); }

    function openSermonModal(){
      if(!CURRENT.paraId){ const openPara = treeEl.querySelector('details.para[open]'); if(!openPara) return; }
      const para = BIBLE.books[CURRENT.book][CURRENT.chap].paras[CURRENT.paraIdx];
      modalRef.textContent = `${CURRENT.book} ${CURRENT.chap}ì¥ Â· ${para.title||para.ref} (${para.ref})`;
      renderSermonList();
      sermonEditor.style.display = 'none';
      sermonEditor.classList.add('context-editor');    // í•­ìƒ ì ìš©
      modalWrap.style.display = 'flex';
      modalWrap.setAttribute('aria-hidden','false');
      modalFooterNew.style.display = '';
    }
    el('closeModal').onclick = ()=>{ modalWrap.style.display='none'; modalWrap.setAttribute('aria-hidden','true'); stopEditorSpeak(true); };

    function openSingleDocEditor(kind){
      const para = BIBLE.books[CURRENT.book][CURRENT.chap].paras[CURRENT.paraIdx];
      const pid  = `${CURRENT.book}|${CURRENT.chap}|${para.ref}`;

      const titlePrefix =
        kind==='unit'       ? 'ë‹¨ìœ„ì„±ê²½ì† ë§¥ë½' :
        kind==='whole'      ? 'ì „ì²´ì„±ê²½ì† ë§¥ë½' :
        kind==='commentary' ? 'ì£¼ì„' :
                              'ë‚´ìš©ìš”ì•½';

      const key = 
        kind==='unit'       ? STORAGE_UNIT_CTX :
        kind==='whole'      ? STORAGE_WHOLE_CTX :
        kind==='commentary' ? STORAGE_COMMENTARY :
                              STORAGE_SUMMARY;

      const map = getDocMap(key);
      const doc = map[pid] || {
        title: `${titlePrefix} â€” ${para.title||para.ref}`,
        body:  (kind==='summary' ? 'í•µì‹¬ ë‚´ìš©ì„ ê°„ê²°í•˜ê²Œ ìš”ì•½í•´ ì ì–´ì£¼ì„¸ìš”.' : ''),
        images: [], date:''
      };

      modalRef.textContent = `${CURRENT.book} ${CURRENT.chap}ì¥ Â· ${para.title||para.ref} (${para.ref}) â€” ${titlePrefix}`;
      sermonList.innerHTML = '';
      sermonEditor.style.display = '';
      sermonEditor.classList.add('context-editor'); // ğŸ‘ˆ ì¶”ê°€
      modalWrap.style.display = 'flex';
      modalWrap.setAttribute('aria-hidden','false');
      modalFooterNew.style.display = 'none';

      sermonTitle.value = doc.title || '';
      sermonBody.value  = doc.body  || '';
      sermonThumbs.innerHTML = '';
      (doc.images||[]).forEach(src=>{ const img=new Image(); img.src=src; sermonThumbs.appendChild(img); });

      sermonEditor.dataset.editing = '';
      sermonEditor.dataset.ctxType = kind;
    }

    function renderSermonList(){
      const map = getSermonMap();
      const arr = map[CURRENT.paraId] || [];
      sermonList.innerHTML = '';
      if(arr.length===0){ startNewSermon(); return; }

      arr.forEach((it, idx)=>{
        const row = document.createElement('div'); row.className='item';
        const dateHtml = it.date ? `<span class="date">${it.date}</span>` : '';
        row.innerHTML = `
          <div class="item-title">
            ${escapeHtml(it.title||'(ì œëª© ì—†ìŒ)')} ${dateHtml}
          </div>
          <div class="ptoolbar">
            <button data-edit="${idx}">í¸ì§‘</button>
            <button data-del="${idx}" style="border-color:var(--danger);color:var(--text)">ì‚­ì œ</button>
          </div>`;
        row.querySelector('[data-edit]').onclick = ()=>{
          modalWrap.style.display = 'none'; modalWrap.setAttribute('aria-hidden','true');
          openSermonEditorWindow(idx);
        };
        row.querySelector('[data-del]').onclick = ()=> deleteSermon(idx);
        sermonList.appendChild(row);
      });
    }

    el('newSermonBtn').onclick = ()=>{
      if (sermonEditor.dataset.ctxType) return;
      const map = getSermonMap();
      const arr = map[CURRENT.paraId] || [];
      arr.unshift({
         id: crypto.randomUUID(),
         title:'(ì œëª© ì—†ìŒ)',
         body:'ì—¬ê¸°ì— ì„¤êµ ë³¸ë¬¸ ì´ˆì•ˆì„ ì…ë ¥í•˜ì„¸ìš”.',
         images:[], date:''
      });
      map[CURRENT.paraId] = arr; setSermonMap(map);

      modalWrap.style.display='none'; modalWrap.setAttribute('aria-hidden','true');
      openSermonEditorWindow(0);
    };

    function startNewSermon(){
      sermonList.innerHTML = '<div class="muted" style="padding:0 14px">ìƒˆ ì„¤êµë¥¼ ì‘ì„±í•´ ì €ì¥í•˜ë©´ ì´ ë‹¨ë½ì— ë¶™ìŠµë‹ˆë‹¤.</div>';
      sermonEditor.classList.add('context-editor');    // í•­ìƒ ì ìš©
      sermonEditor.style.display = '';
      sermonTitle.value = ''; sermonBody.value = ''; sermonThumbs.innerHTML = ''; sermonImages.value = '';
      sermonEditor.dataset.editing = '';
      stopEditorSpeak(true);
    }
    function editSermon(idx){
      const map = getSermonMap(); const arr = map[CURRENT.paraId] || []; const it = arr[idx]; if(!it) return;
      sermonEditor.classList.add('context-editor');    // í•­ìƒ ì ìš©
      sermonEditor.style.display = ''; sermonEditor.dataset.editing = String(idx);
      sermonTitle.value = it.title||''; sermonBody.value = it.body||''; sermonThumbs.innerHTML = '';
      (it.images||[]).forEach(src=>{ const img=new Image(); img.src=src; sermonThumbs.appendChild(img); });
      stopEditorSpeak(true);
    }
    function deleteSermon(idx){
      if(!confirm('ì´ ì„¤êµë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
      const map = getSermonMap(); const arr = map[CURRENT.paraId] || [];
      arr.splice(idx,1); map[CURRENT.paraId] = arr; setSermonMap(map); renderSermonList();
    }

    el('cancelEdit').onclick = ()=>{
      if(sermonEditor.dataset.ctxType){
        sermonEditor.dataset.ctxType = '';
        modalWrap.style.display = 'none'; modalWrap.setAttribute('aria-hidden','true');
      }else{
        sermonEditor.style.display = 'none'; renderSermonList();
      }
      stopEditorSpeak(true);
    };

    el('saveSermon').onclick = ()=>{
      sermonBody.value=stripBlankLines(sermonBody.value);
      const title = sermonTitle.value.trim() || '(ì œëª© ì—†ìŒ)';
      const body  = sermonBody.value.trim();
      const imgs  = [...sermonThumbs.querySelectorAll('img')].map(img=>img.src);
      const now   = new Date();
      const date  = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;

      const para  = BIBLE.books[CURRENT.book][CURRENT.chap].paras[CURRENT.paraIdx];
      const pid   = `${CURRENT.book}|${CURRENT.chap}|${para.ref}`;
      const ctxType = sermonEditor.dataset.ctxType || '';

      if(ctxType){
        const key = ctxType==='unit'       ? STORAGE_UNIT_CTX
                  : ctxType==='whole'      ? STORAGE_WHOLE_CTX
                  : ctxType==='commentary' ? STORAGE_COMMENTARY
                  :                          STORAGE_SUMMARY;
        const map = getDocMap(key);
        map[pid] = { title, body, images: imgs, date };
        setDocMap(key, map);

        sermonEditor.dataset.ctxType = '';
        sermonEditor.classList.remove('context-editor'); // ğŸ‘ˆ ì¶”ê°€
        modalWrap.style.display = 'none'; modalWrap.setAttribute('aria-hidden','true');
        status(`ì €ì¥ë¨: ${title}`);
        return;
      }

      const map = getSermonMap();
      const arr = map[CURRENT.paraId] || [];
      const editing = sermonEditor.dataset.editing;
      if(editing!==''){ const i=+editing; if(arr[i]) arr[i] = {...arr[i], title, body, images:imgs, date}; }
      else { arr.unshift({ id: crypto.randomUUID(), title, body, images: imgs, date }); }
      map[CURRENT.paraId] = arr; setSermonMap(map);
      sermonEditor.style.display = 'none'; renderSermonList(); status('ì„¤êµê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    };

    sermonImages.addEventListener('change', async ()=>{
      const files = [...sermonImages.files||[]];
      for(const f of files){ const data = await fileToDataURL(f); const img = new Image(); img.src = data; sermonThumbs.appendChild(img); }
      sermonImages.value = '';
    });

    /* --------- Editor TTS --------- */
    editorSpeakBtn.onclick = ()=> toggleEditorSpeak();
    function toggleEditorSpeak(){
      sermonBody.value=stripBlankLines(sermonBody.value);
      if(!EDITOR_READER.synth) return alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±í•©ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      if(EDITOR_READER.playing){ stopEditorSpeak(); return; }
      const text = [sermonTitle.value.trim(), sermonBody.value.trim()].filter(Boolean).join('. ');
      if(!text){ alert('ë‚­ë…í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const u = new SpeechSynthesisUtterance(text.replace(/\n{2,}/g, '. ').replace(/\n/g,' '));
      applyVoice(u); u.onend = ()=> stopEditorSpeak(true);
      EDITOR_READER.u = u; EDITOR_READER.synth.cancel(); EDITOR_READER.synth.speak(u);
      EDITOR_READER.playing = true; editorSpeakBtn.textContent = 'ì¤‘ì§€';
    }
    function stopEditorSpeak(silent){
      if(EDITOR_READER.synth){ try{ EDITOR_READER.synth.cancel(); }catch(e){} }
      EDITOR_READER.playing = false; EDITOR_READER.u = null;
      if(!silent) status('ì„¤êµ ë‚­ë…ì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.'); editorSpeakBtn.textContent = 'ë‚­ë…';
    }

    /* --------- Misc --------- */
   
window.addEventListener('keydown', (e)=>{
  // ì €ì¥ í•«í‚¤ (Ctrl+Shift+S)
  if(e.ctrlKey && e.shiftKey && e.key.toLowerCase()==='s'){
    e.preventDefault();
    downloadBibleJSON();
    return;
  }

  // ì…ë ¥ í¬ì»¤ìŠ¤ ì¤‘ì´ë©´ ë¬´ì‹œ
  if(e.target && ['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;

  const key = e.key.toLowerCase();

  // S = í˜„ì¬ ì—´ë¦° ë‹¨ë½ ê¸°ì¤€ ë‚­ë… í† ê¸€
  if(key === 's'){
    e.preventDefault();
    // í˜¹ì‹œ í† ê¸€ ì´ë²¤íŠ¸ê°€ ì•ˆ íƒ”ì„ ë•Œë¥¼ ëŒ€ë¹„í•´ ì—´ë¦° ë‹¨ë½ìœ¼ë¡œ ìƒíƒœ ë³´ì •
    syncCurrentFromOpen();

    const openPara = treeEl.querySelector('details.para[open]');
    if(openPara && CURRENT.book!=null){
      const btn = openPara.querySelector('.speakBtn');
      toggleSpeakInline(CURRENT.book, CURRENT.chap, CURRENT.paraIdx, openPara, btn);
    }
    return;
  }

  // N = ë‹¤ìŒ ë‹¨ë½ìœ¼ë¡œ ì´ë™ (ì¬ìƒ ì¤‘ì´ë©´ ìë™ ì´ì–´ì½ê¸°)
  if(key === 'n'){
    e.preventDefault();

    // ì—´ë¦° ë‹¨ë½ ê¸°ì¤€ìœ¼ë¡œ ìƒíƒœ ë³´ì •
    if(!syncCurrentFromOpen()) return;

    const wasPlaying = !!READER.playing;

    // í˜„ì¬ ë°œí™” ì •ë¦¬
    try{ READER.synth && READER.synth.cancel(); }catch(_){}
    if (READER._wd){ clearTimeout(READER._wd); READER._wd = null; }

    // ì¬ìƒ ì˜ë„ ìœ ì§€
    READER.playing = wasPlaying;

    // ë‹¤ìŒ ë‹¨ë½ ì´ë™
    const moved = goToNextParagraphInline(CURRENT.book, CURRENT.chap, CURRENT.paraIdx);
    if(!moved) return;

    // ì¬ìƒ ì¤‘ì´ì—ˆë‹¤ë©´ ê³§ë°”ë¡œ ì´ì–´ ì½ê¸°
    if (wasPlaying){
      // ì „ì—­ continuous ìœ ì§€ + ìƒˆ ë‹¨ë½ ì²´í¬ UI ë™ê¸°í™”(+ê°•ì œ ëª¨ë“œë©´ ë¹„í™œì„±)
      const cb = READER.scope?.querySelector?.('.keepReading');
      if(cb){
        cb.checked  = READER.continuous;
        cb.disabled = !!READER.forced; // â˜…
      }
    
      READER.q   = buildQueueFrom(CURRENT.book, CURRENT.chap, CURRENT.paraIdx);
      READER.idx = 0;
    
      bindKeepReading(READER.scope);
      updateInlineSpeakBtn();
    
      setTimeout(()=>{
        try{ READER.synth && READER.synth.cancel(); }catch(_){}
        playNextInQueueInline(CURRENT.book, CURRENT.chap, CURRENT.paraIdx);
      }, 120);
    }

  }
});



/* --------- Sermon Editor Popup (Slim) --------- */
function openSermonEditorWindow(idx){
  const map = getSermonMap();
  const arr = map[CURRENT.paraId] || [];
  const it  = arr[idx];
  if(!it){ alert('í¸ì§‘í•  ì„¤êµë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

  const meta = {
    paraId: CURRENT.paraId,
    ref: `${CURRENT.book} ${CURRENT.chap}ì¥`,
    title: it.title || '',
    body:  it.body  || '',
    images: it.images || [],
    date: it.date || ''
  };

const w = window.open('', '_blank', 'width=1100,height=800');
if (!w) { alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.'); return; }

// âœ… ì´ ì¤„ì´ â€œì œëª©/ë³¸ë¬¸ ì£¼ì…â€ì˜ í•µì‹¬ì…ë‹ˆë‹¤.
w.__WBPS_META__ = meta;

w.document.open();
w.document.write(popupHTML);
w.document.close();
  
const popupHTML = String.raw`<!DOCTYPE html><html lang="ko">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ì„¤êµ í¸ì§‘</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600&family=Nanum+Myeongjo&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f1115;--panel:#161922;--text:#e6e8ef;--muted:#9aa0ab;--border:#252a36;--accent:#6ea8fe;--danger:#ff6b6b}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:"Noto Serif KR","Nanum Myeongjo",serif;display:grid;grid-template-rows:56px 1fr 56px;gap:8px}
    header,footer{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--panel);border-bottom:1px solid var(--border)}
    footer{border-top:1px solid var(--border);border-bottom:none}
    .grow{flex:1 1 auto}
    header strong{font-size:15px;letter-spacing:.01em}
    main{padding:0 12px 12px}
    .row{display:grid;gap:8px;margin-bottom:10px}
    input[type="text"],textarea{width:100%;background:#161922;color:#e6e8ef;border:1px solid #2a3040;border-radius:10px;padding:12px 14px;box-shadow:0 6px 16px rgba(0,0,0,.18)}
    input[type="text"]{font-weight:600;font-size:1.12rem;letter-spacing:.01em}
    textarea{min-height:56vh;resize:vertical;line-height:1.9;letter-spacing:.015em;caret-color:var(--accent)}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .thumbs img{width:96px;height:96px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
    .muted{color:var(--muted)}
    button{background:color-mix(in hsl,var(--panel) 65%,black 10%);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer;transition:border-color .15s,transform .04s}
    button:hover{border-color:color-mix(in hsl,var(--border) 75%,var(--accent) 25%)}
    button:active{transform:translateY(1px)}
    .primary{background:linear-gradient(180deg,color-mix(in srgb,var(--accent) 78%,white 10%),color-mix(in srgb,var(--accent) 72%,black 22%));border-color:color-mix(in srgb,var(--accent) 70%,black 10%)}
    .danger{border-color:var(--danger);color:#ffd7d7;background:transparent}
    .pill{display:flex;gap:8px;align-items:center;border:1px solid var(--border);background:color-mix(in hsl,var(--panel) 80%,black 8%);padding:6px 8px;border-radius:10px}
    .ctrl{appearance:none;width:140px;height:6px;border-radius:999px;background:#2a3040;outline:none}
    select{background:transparent;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:4px 6px}
    option{color:#000}
    /* ë³¸ë¬¸ íƒ€ì´í¬ */
    ::selection{background:rgba(110,168,254,.25)}
    em,strong,b{color:#ffd66e;font-weight:600;font-style:normal}
    blockquote{margin:12px 0;padding:10px 14px;border-left:3px solid var(--accent);color:#c0cad6;font-style:italic;background:rgba(255,255,255,.04);border-radius:8px}
  </style>
</head>
<body>
  <header>
    <strong>ì„¤êµ í¸ì§‘</strong><span class="muted" id="ref"></span>
    <div class="grow"></div>

    <!-- ë‹¨ë½ ì„¤êµì™€ ë™ì¼í•œ ë³´ì´ìŠ¤ ì„ íƒ UI -->
    <div class="pill" id="voiceWrap">
      <span class="muted">ìŒì„±</span>
      <select id="vsel" title="í•œêµ­ì–´ ë³´ì´ìŠ¤ ì„ íƒ">
        <option value="">ë¸Œë¼ìš°ì € ê¸°ë³¸(ko-KR)</option>
      </select>
      <button id="vtest">ì‹œí—˜</button>
    </div>

    <div class="pill">
      <span class="muted">ì†ë„</span><input id="rate" class="ctrl" type="range" min="0.6" max="1.4" step="0.02" value="0.95">
      <span class="muted">í†¤</span><input id="pitch" class="ctrl" type="range" min="0.6" max="1.4" step="0.02" value="1.00">
    </div>
    <button id="x">ë‹«ê¸°</button>
  </header>

  <main>
    <div class="row">
      <input id="t" placeholder="ì„¤êµ ì œëª©">
      <textarea id="b" placeholder="ì„¤êµ ë³¸ë¬¸(í…ìŠ¤íŠ¸)"></textarea>
    </div>
    <div class="row">
      <input type="file" id="imgs" accept="image/*" multiple>
      <div class="thumbs" id="th"></div>
    </div>
  </main>

  <footer>
    <span class="muted" id="date"></span><div class="grow"></div>
    <button id="read" class="primary">ë‚­ë…</button>
    <button id="stop">ì¤‘ì§€</button>
    <button class="danger" id="d">ì‚­ì œ</button>
    <button class="primary" id="s">ì €ì¥</button>
  </footer>

  <script>
    // ===== ë©”íƒ€ ìˆ˜ì‹ (ë¶€ëª¨ê°€ window.__WBPS_META__ì— ë„£ì–´ì¤Œ)
    const meta = window.__WBPS_META__ || { title:'', body:'', images:[], date:'', ref:'' };

    // ===== ë©”íƒ€ ì£¼ì…
    refEl.textContent='â€” '+(meta.ref||'');
    dateEl.textContent=meta.date?('ìµœê·¼ ì €ì¥: '+meta.date):'';
    t.value=meta.title||'';
    b.value=meta.body||'';
    (meta.images||[]).forEach(src=>{const im=new Image();im.src=src;th.appendChild(im)});
    
    window.__WBPS_META_DEBUG__ = meta; // ë””ë²„ê¹… ìš©ì´

    // ===== ê³µí†µ ìœ í‹¸ (ë¶€ëª¨ì™€ ë™ì¼)
    const VOICE_CHOICE_KEY='wbps.tts.choice.v2';
    function stripBlankLines(s){return String(s||'').split(/\\r?\\n/).filter(l=>l.trim()!=='').join('\\n');}
    function clamp(n,min,max){return Math.max(min,Math.min(max,n));}

    // --- ë³´ì´ìŠ¤ ìœ í‹¸ (ë¶€ëª¨ì™€ ë™ì¼)
    function waitForVoices(timeout=1500){
      return new Promise(resolve=>{
        const have = speechSynthesis.getVoices?.(); if(have&&have.length) return resolve(have);
        const t=setTimeout(()=>resolve(speechSynthesis.getVoices?.()||[]),timeout);
        speechSynthesis.onvoiceschanged=()=>{clearTimeout(t);resolve(speechSynthesis.getVoices?.()||[]);}
      });
    }
    function getKoreanVoices(all){
      return (all||[]).filter(v=>{
        const n=(v.name||'').toLowerCase(), l=(v.lang||'').toLowerCase();
        return l.startsWith('ko')||n.includes('korean')||n.includes('í•œêµ­')||n.includes('korea');
      });
    }
    function presetsForSingleVoice(){
      return [
        {id:'preset-soft-low',  label:'í”„ë¦¬ì…‹ Â· ì €ìŒ/ëŠë¦¼', rate:0.85, pitch:0.85},
        {id:'preset-soft-high', label:'í”„ë¦¬ì…‹ Â· ê³ ìŒ/ëŠë¦¼', rate:0.90, pitch:1.20},
        {id:'preset-fast',      label:'í”„ë¦¬ì…‹ Â· ë¹ ë¦„',     rate:1.20, pitch:1.05},
        {id:'preset-bright',    label:'í”„ë¦¬ì…‹ Â· ë°ê²Œ',     rate:1.05, pitch:1.25},
        {id:'preset-radio',     label:'í”„ë¦¬ì…‹ Â· ë¼ë””ì˜¤í†¤', rate:1.00, pitch:0.90},
        {id:'preset-reading',   label:'í”„ë¦¬ì…‹ Â· ë‚­ë…ì²´',   rate:0.95, pitch:1.00},
      ];
    }
    function resolveVoiceChoice(){
      try{ return JSON.parse(localStorage.getItem(VOICE_CHOICE_KEY)||'{"type":"default"}'); }
      catch{ return {type:'default'}; }
    }
    function pickVoiceByURI(uri){ return (speechSynthesis.getVoices?.()||[]).find(v=>v.voiceURI===uri)||null; }
    function applyVoice(u, rateCtl, pitchCtl){
      const choice = resolveVoiceChoice();
      const baseRate = parseFloat(rateCtl.value||'0.95');
      const basePitch = parseFloat(pitchCtl.value||'1.0');
      if(choice.type==='voice'){
        const v = pickVoiceByURI(choice.uri);
        if(v){u.voice=v;u.lang=v.lang;} else {u.lang='ko-KR';}
        u.rate=baseRate; u.pitch=basePitch;
      }else if(choice.type==='preset'){
        u.lang='ko-KR';
        u.rate = clamp((choice.rate??0.95)*baseRate/0.95,0.5,2);
        u.pitch= clamp((choice.pitch??1.0)*basePitch/1.0,0,2);
      }else{
        u.lang='ko-KR';u.rate=baseRate;u.pitch=basePitch;
      }
    }

    // ===== UI refs
    const t=document.getElementById('t');
    const b=document.getElementById('b');
    const th=document.getElementById('th');
    const imgs=document.getElementById('imgs');
    const refEl=document.getElementById('ref');
    const dateEl=document.getElementById('date');
    const rate=document.getElementById('rate');
    const pitch=document.getElementById('pitch');
    const btnRead=document.getElementById('read');
    const btnStop=document.getElementById('stop');
    const btnSave=document.getElementById('s');
    const btnDel=document.getElementById('d');
    const btnClose=document.getElementById('x');
    const vsel=document.getElementById('vsel');
    const vtest=document.getElementById('vtest');

    // ===== ë³´ì´ìŠ¤ ì…‹ì—…(ë¶€ëª¨ì™€ ë™ì¼)
    (async function setupVoices(){
      const all = await waitForVoices();
      const kos = getKoreanVoices(all);
      vsel.innerHTML='';
      const def=document.createElement('option');
      def.value=JSON.stringify({type:'default'});
      def.textContent='ë¸Œë¼ìš°ì € ê¸°ë³¸(ko-KR)';
      vsel.appendChild(def);

      if(kos.length>0){
        const og=document.createElement('optgroup'); og.label='í•œêµ­ì–´ ë³´ì´ìŠ¤';
        kos.forEach(v=>{
          const opt=document.createElement('option');
          opt.value=JSON.stringify({type:'voice',uri:v.voiceURI});
          opt.textContent=`${v.name} â€” ${v.lang}${v.localService?' (ë¡œì»¬)':''}`;
          og.appendChild(opt);
        });
        vsel.appendChild(og);
      }
      if(kos.length<=1){
        const pg=document.createElement('optgroup'); pg.label='ìŠ¤íƒ€ì¼ í”„ë¦¬ì…‹';
        presetsForSingleVoice().forEach(p=>{
          const opt=document.createElement('option');
          opt.value=JSON.stringify({type:'preset',rate:p.rate,pitch:p.pitch});
          opt.textContent=p.label;
          pg.appendChild(opt);
        });
        vsel.appendChild(pg);
      }

      const saved=localStorage.getItem(VOICE_CHOICE_KEY);
      if(saved){
        const idx=[...vsel.options].findIndex(o=>o.value===saved);
        if(idx>=0) vsel.selectedIndex=idx;
      }else{
        localStorage.setItem(VOICE_CHOICE_KEY, vsel.value);
      }
      vsel.addEventListener('change',()=>localStorage.setItem(VOICE_CHOICE_KEY,vsel.value));
      vtest.onclick = ()=>{
        const u=new SpeechSynthesisUtterance('íƒœì´ˆì— í•˜ë‚˜ë‹˜ì´ ì²œì§€ë¥¼ ì°½ì¡°í•˜ì‹œë‹ˆë¼.');
        applyVoice(u,rate,pitch);
        try{speechSynthesis.cancel();}catch(e){}
        speechSynthesis.speak(u);
      };
    })();

    // ===== ì—ë””í„° UX
    b.addEventListener('blur',()=>{b.value=stripBlankLines(b.value);});
    b.addEventListener('paste',()=>{setTimeout(()=>{const pos=b.selectionStart;b.value=stripBlankLines(b.value);if(typeof pos==='number'){b.setSelectionRange(pos,pos);} },0);});

    function fileToDataURL(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(file)})}
    imgs.addEventListener('change',async()=>{
      const files=[...imgs.files||[]];
      for(const f of files){const data=await fileToDataURL(f);const im=new Image();im.src=data;th.appendChild(im)}
      imgs.value='';
    });

    // ===== ë‚­ë…(ë¶€ëª¨ì™€ ê°™ì€ ë³´ì´ìŠ¤ ì ìš©)
    const synth=window.speechSynthesis||null;
    function speakText(txt){
      if(!synth){alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±í•©ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');return}
      try{synth.cancel()}catch(e){}
      const u=new SpeechSynthesisUtterance(txt);
      applyVoice(u,rate,pitch);
      synth.speak(u);
    }
    btnRead.onclick=()=>{
      b.value=stripBlankLines(b.value);
      const txt=[(t.value||'').trim(),(b.value||'').replace(/\\n{2,}/g,'. ').replace(/\\n/g,' ').trim()].filter(Boolean).join('. ');
      if(!txt){alert('ë‚­ë…í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');return}
      speakText(txt);
    };
    btnStop.onclick=()=>{try{synth&&synth.cancel()}catch(e){}};

    // ===== ì €ì¥/ì‚­ì œ/ë‹«ê¸° (ë¶€ëª¨ì°½ìœ¼ë¡œ postMessage)
    btnSave.onclick=()=>{
      b.value=stripBlankLines(b.value);
      const images=[...th.querySelectorAll('img')].map(i=>i.src);
      opener.postMessage({type:'sermon-save',title:(t.value||'').trim()||'(ì œëª© ì—†ìŒ)',body:(b.value||'').trim(),images},'*');
      window.close();
    };
    btnDel.onclick=()=>{
      if(confirm('ì‚­ì œí• ê¹Œìš”?')){
        opener.postMessage({type:'sermon-delete'},'*');
        window.close();
      }
    };
    btnClose.onclick=()=>window.close();

    // ===== ë‹¨ì¶•í‚¤ (ë©”ì¸ê³¼ ìœ ì‚¬ UX)
    window.addEventListener('keydown',e=>{
      const key=e.key.toLowerCase();
      const ctrl=e.ctrlKey||e.metaKey; // Mac âŒ˜ ì§€ì›

      if(ctrl && key==='s'){ // Ctrl/Cmd+S => ì €ì¥
        e.preventDefault();
        btnSave.click();
        return;
      }
      if(ctrl && key==='enter'){ // Ctrl/Cmd+Enter => ì €ì¥
        e.preventDefault();
        btnSave.click();
        return;
      }
      if(key==='escape'){ // Esc => ë‹«ê¸°
        e.preventDefault();
        window.close();
        return;
      }
    });
  </script>
</body></html>`;

  // ë¶€ëª¨ì°½ ì‘ë‹µ ìˆ˜ì‹ 
  const onMsg = (ev)=>{
    const data = ev?.data||{};
    if(!data.type) return;
    const map = getSermonMap();
    const arr = map[CURRENT.paraId] || [];

    if(data.type==='sermon-save'){
      const now = new Date();
      const date = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
      if(arr[idx]) arr[idx] = { ...arr[idx], title: data.title, body: data.body, images: data.images, date };
      map[CURRENT.paraId] = arr; setSermonMap(map);
      status('ì„¤êµê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      renderSermonList();
      window.removeEventListener('message', onMsg);
    }
    if(data.type==='sermon-delete'){
      if(arr[idx]) arr.splice(idx,1);
      map[CURRENT.paraId] = arr; setSermonMap(map);
      status('ì„¤êµê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      renderSermonList();
      window.removeEventListener('message', onMsg);
    }
  };
  window.addEventListener('message', onMsg);
}


  </script>
</body>
</html>
