<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web Bible – Paragraph Sermon (Final Slim)</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#161922; --text:#e6e8ef; --muted:#9aa0ab;
      --accent:#6ea8fe; --border:#252a36; --danger:#ff6b6b; --titleBlue:#9fd0ff;
    }
    *{ box-sizing:border-box } html,body{ height:100% }
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
      background:var(--bg); color:var(--text);
      display:grid; grid-template-rows:64px 1fr; gap:10px;
    }
    header{
      display:flex; align-items:center; gap:10px; padding:8px 10px;
      background:var(--panel); border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:5;
    }
    header h1{ font-size:16px; margin:0; font-weight:700 }
    .muted{ color:var(--muted) }
    .pill{
      display:flex; gap:8px; align-items:center; border:1px solid var(--border);
      background:color-mix(in hsl, var(--panel) 80%, black 8%); padding:6px 8px; border-radius:10px;
    }
    select, input[type="range"]{ background:transparent; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:4px 6px }
    option{ color:#000 }
    button{
      background:color-mix(in hsl, var(--panel) 65%, black 10%); color:var(--text);
      border:1px solid var(--border); border-radius:10px; padding:6px 10px; cursor:pointer;
    }
    button:hover{ border-color:color-mix(in hsl, var(--border) 80%, var(--accent) 20%) }
    .primary{
      background:linear-gradient(180deg,color-mix(in srgb, var(--accent) 75%, white 10%), color-mix(in srgb, var(--accent) 75%, black 20%));
      border-color:color-mix(in srgb, var(--accent) 70%, black 10%);
    }

    .layout{ display:grid; grid-template-columns:1fr; gap:10px; padding:0 10px 12px }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:14px; overflow:hidden; display:flex; flex-direction:column; min-width:0 }
    .scroller{ overflow:auto; padding:12px }
    .footer{ padding:8px 12px; border-top:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap }

    #tree{ padding:8px }
    details{
      border:1px solid var(--border); border-radius:10px; padding:6px 8px; margin-bottom:8px;
      background:color-mix(in hsl, var(--panel) 80%, black 8%);
    }
    summary{ cursor:pointer; list-style:none; display:flex; align-items:center; gap:8px }
    summary::-webkit-details-marker{ display:none }
    .tw{ font-weight:700 }
    .chapters{ display:grid; gap:6px; margin-top:6px }
    .paras{ display:grid; gap:6px; margin:8px 0 2px }
    .chip{
      font-size:.92em; padding:6px 10px; border:1px solid var(--border); border-radius:999px;
      display:inline-flex; align-items:center; gap:6px; background:color-mix(in hsl, var(--panel) 88%, black 4%); white-space:nowrap;
    }
    .chip:hover{ border-color:var(--accent) }
    .ptitle{ font-weight:800; color:var(--titleBlue) }
    .vrange{ color:var(--muted); font-weight:700 }

    .pbody{ margin-top:8px; border-top:1px dashed var(--border); padding-top:8px }
    .ptoolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px }
    .pline{ padding:4px 6px; border-left:3px solid transparent; border-radius:8px; transition: background .15s, border-color .15s }
    .pline:hover{ background:color-mix(in hsl, var(--panel) 80%, black 12%) }
    .pline.reading{ background:color-mix(in hsl, var(--accent) 15%, black 0%); border-left-color:var(--accent) }
    .pv{ color:var(--muted); font-size:.88em; vertical-align:super; margin-right:4px }

    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50 }
    .modal{ width:min(1200px, 96vw); max-height:94vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:14px }
    .modal .head{
      position:sticky; top:0; background:var(--panel); padding:12px 14px;
      display:flex; gap:10px; align-items:center; border-bottom:1px solid var(--border)
    }
    .list{ padding:12px 14px; display:grid; gap:0 }
    .item{ border:1px solid var(--border); border-radius:10px; padding:2px 8px; display:flex; justify-content:space-between; align-items:center; gap:8px }
    .item-title{ font-weight:700; color:var(--titleBlue); line-height:1.15 }
    .item-title .date{ margin-left:8px; color:var(--muted); font-weight:400; font-size:.92em }

    .editor{ padding:14px; display:grid; gap:12px; background:var(--panel) }
    .editor input[type="text"], .editor textarea{ width:100%; background:#161922; color:#e6e8ef; border:1px solid #2a3040; border-radius:8px; padding:10px 12px }
    .editor textarea{ min-height:360px; resize:vertical }
    .thumbs{ display:flex; gap:8px; flex-wrap:wrap }
    .thumbs img{ width:112px; height:112px; object-fit:cover; border-radius:10px; border:1px solid var(--border) }
    .editor-bar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .editor-bar .grow{ flex:1 1 auto }
  </style>
</head>

<body>
  <header>
    <h1>Web Bible – Paragraph Sermon</h1>

    <div class="pill">
      <button id="btnSaveJSON">JSON 저장</button>
    </div>

    <div class="pill">
      <button id="btnExportAll">내보내기</button>
      <input id="importFile" type="file" accept="application/json" style="display:none">
      <button id="btnImportAll">가져오기</button>
    </div>
    
    <div class="pill">
      <span class="muted">음성</span>
      <select id="voiceSelect" title="한국어 보이스 선택">
        <option value="">브라우저 기본(ko-KR)</option>
      </select>
      <button id="testVoice">시험</button>
    </div>

    <div class="pill">
      <span class="muted">속도</span>
      <input id="rateCtl" type="range" min="0.6" max="1.4" step="0.02" value="0.95" />
      <span class="muted">톤</span>
      <input id="pitchCtl" type="range" min="0.6" max="1.4" step="0.02" value="1.00" />
    </div>

    <div class="pill" id="voiceHint" style="display:none">
      <span class="muted">한국어 보이스가 1개뿐이라 스타일 프리셋을 추가했습니다.</span>
    </div>

    <div style="flex:1"></div>
    <div class="pill"><span class="muted">단축키:</span> <span> S</span> 재생/중지 <span> · N</span> 다음 단락</div>
  </header>

  <div class="layout">
    <section class="card">
      <div class="scroller"><div id="tree"></div></div>
      <div class="footer"><div class="muted" id="status">bible-paragraph.json을 불러오는 중…</div></div>
    </section>
  </div>

  <div id="modalWrap" class="modal-backdrop" aria-hidden="true">
    <div class="modal">
      <div class="head">
        <strong>단락 설교</strong>
        <span class="muted" id="modalRef">—</span>
        <div class="grow"></div>
        <button id="closeModal">닫기</button>
      </div>

      <div class="list" id="sermonList"></div>

      <div class="editor" id="sermonEditor" style="display:none">
        <input type="text" id="sermonTitle" placeholder="제목" />
        <textarea id="sermonBody" placeholder="내용"></textarea>
        <div class="editor-bar">
          <input type="file" id="sermonImages" accept="image/*" multiple />
          <div class="grow"></div>
          <button id="editorSpeak" class="primary">낭독</button>
          <button id="saveSermon" class="primary">저장</button>
          <!-- ★ 컨텍스트 문서 삭제 버튼(주석/요약/맥락) -->
          <button id="deleteCtxDoc" style="border:1px solid var(--danger);color:#ffd7d7;background:transparent;display:none">삭제</button>
          <button id="cancelEdit">취소</button>
        </div>
        <div class="thumbs" id="sermonThumbs"></div>
      </div>

      <div id="modalFooterNew" class="footer" style="padding:10px 14px; border-top:1px solid var(--border)">
        <button id="newSermonBtn" class="primary">새 설교</button>
      </div>
    </div>
  </div>

  <script>
    /* --------- Utils --------- */
    const el = id => document.getElementById(id);
    function status(msg){ statusEl.textContent = msg; }
    function escapeHtml(s){ return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
    function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
    function todayStr(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

    // ==== 인라인 제목 편집 ====
    function startInlineTitleEdit(el, book, chap, idx){
      const old = el.textContent.trim();
      el.setAttribute('contenteditable','plaintext-only');
      el.spellcheck = false;
      el.classList.add('editing');
      el.focus();
      const sel = window.getSelection();
      const range = document.createRange();
      range.selectNodeContents(el);
      sel.removeAllRanges(); sel.addRange(range);

      function finish(commit){
        el.removeAttribute('contenteditable');
        el.classList.remove('editing');
        document.removeEventListener('keydown', onKey, true);
        el.removeEventListener('blur', onBlur);
        if(commit){
          const newTitle = el.textContent.trim() || '(제목 없음)';
          updateParaTitle(book, chap, idx, newTitle);
          status('단락 제목이 변경되었습니다. (Ctrl+Shift+S로 JSON 저장 가능)');
        }else{
          el.textContent = old;
          status('제목 편집이 취소되었습니다.');
        }
      }
      function onKey(e){
        if(e.key === 'Enter'){ e.preventDefault(); finish(true); }
        if(e.key === 'Escape'){ e.preventDefault(); finish(false); }
      }
      function onBlur(){ finish(true); }
      document.addEventListener('keydown', onKey, true);
      el.addEventListener('blur', onBlur);
    }
    
    // 메모리(BIBLE) 데이터 갱신
    function updateParaTitle(book, chap, idx, newTitle){
      try{
        const para = BIBLE?.books?.[book]?.[chap]?.paras?.[idx];
        if(!para) return;
        para.title = newTitle;
        const s = document.querySelector(
          `summary .ptitle[data-book="${CSS.escape(String(book))}"][data-ch="${CSS.escape(String(ch))}"][data-idx="${CSS.escape(String(idx))}"]`
        );
        if(s) s.textContent = newTitle;
      }catch(_){}
    }
    
    // ==== JSON 내보내기(본문) ====
    function downloadBibleJSON(){
      if(!BIBLE){ alert('BIBLE 데이터가 없습니다.'); return; }
      const blob = new Blob([JSON.stringify(BIBLE, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'bible-paragraphs.json';
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
      status('수정된 JSON을 다운로드했습니다.');
    }

    // ==== (신규) 전체 데이터 백업/복원 ====
    const STORAGE_SERMON      = 'wbps.sermons.v4';
    const STORAGE_UNIT_CTX    = 'wbps.ctx.unit.v1';
    const STORAGE_WHOLE_CTX   = 'wbps.ctx.whole.v1';
    const STORAGE_COMMENTARY  = 'wbps.ctx.comm.v1';
    const STORAGE_SUMMARY     = 'wbps.ctx.summary.v1';
    const VOICE_CHOICE_KEY    = 'wbps.tts.choice.v2';

    function exportAllData(){
      const keys = [
        STORAGE_SERMON, STORAGE_UNIT_CTX, STORAGE_WHOLE_CTX,
        STORAGE_COMMENTARY, STORAGE_SUMMARY, VOICE_CHOICE_KEY
      ];
      const payload = { __wbps:1, date: todayStr(), items:{} };
      keys.forEach(k=> payload.items[k] = localStorage.getItem(k) ?? null);

      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      const ts = new Date(); const tss = `${ts.getFullYear()}${String(ts.getMonth()+1).padStart(2,'0')}${String(ts.getDate()).padStart(2,'0')}-${String(ts.getHours()).padStart(2,'0')}${String(ts.getMinutes()).padStart(2,'0')}`;
      a.href = URL.createObjectURL(blob);
      a.download = `wbps-backup-${tss}.json`;
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
      status('전체 데이터를 내보냈습니다.');
    }

    async function importAllData(file){
      try{
        const text = await file.text();
        const json = JSON.parse(text);
        if(!json || json.__wbps!==1 || !json.items){ alert('백업 파일 형식이 아닙니다.'); return; }
        if(!confirm('이 백업을 가져와서 현재 기기의 데이터를 덮어쓸까요?')) return;
        Object.entries(json.items).forEach(([k,v])=>{
          if(v===null || v===undefined) localStorage.removeItem(k);
          else localStorage.setItem(k, v);
        });
        status('가져오기가 완료되었습니다. 페이지를 새로고침하면 반영됩니다.');
      }catch(e){
        console.error(e); alert('가져오기 중 오류가 발생했습니다.');
      }
    }
    
    /* --------- Refs --------- */
    const treeEl = el('tree'), statusEl = el('status');
    const voiceSelect = el('voiceSelect'), testVoiceBtn = el('testVoice');
    const rateCtl = el('rateCtl'), pitchCtl = el('pitchCtl'), voiceHint = el('voiceHint');
    const modalWrap = el('modalWrap'), modalRef = el('modalRef');
    const sermonList = el('sermonList'), sermonEditor = el('sermonEditor');
    const sermonTitle = el('sermonTitle'), sermonBody = el('sermonBody');
    const sermonThumbs = el('sermonThumbs'), sermonImages = el('sermonImages');
    const editorSpeakBtn = el('editorSpeak');
    const modalFooterNew = el('modalFooterNew');

    let BIBLE = null;
    let CURRENT = { book:null, chap:null, paraIdx:null, paraId:null };
    let READER = { playing:false, q:[], idx:0, synth:window.speechSynthesis||null, scope:null, btn:null, continuous:false };
    let EDITOR_READER = { playing:false, u:null, synth:window.speechSynthesis||null };

    /* --------- Boot --------- */
    (async function boot(){
      try{
        BIBLE = await tryFetchJSON('bible-paragraph.json');
      }catch(_){
        try{ BIBLE = await tryFetchJSON('bible_paragraphs.json'); }
        catch(e){ status('bible-paragraph.json을 찾을 수 없습니다. 같은 폴더에 두고 다시 열어주세요.'); return; }
      }
      buildTree();
      status('불러오기 완료. 66권 트리가 활성화되었습니다.');
      await setupVoices();
    })();

    // 버튼 바인딩
    (function bindButtons(){
      const btnSaveJSON = document.getElementById('btnSaveJSON');
      if (btnSaveJSON) btnSaveJSON.addEventListener('click', downloadBibleJSON);
      el('btnExportAll').onclick = exportAllData;
      el('btnImportAll').onclick = ()=> el('importFile').click();
      el('importFile').addEventListener('change', (e)=>{
        const f = e.target.files?.[0]; if(!f) return;
        importAllData(f).finally(()=>{ e.target.value=''; });
      });
    })();
    
    async function tryFetchJSON(path){ const res = await fetch(path, {cache:'no-store'}); if(!res.ok) throw 0; return await res.json(); }

    /* --------- Voice --------- */
    function waitForVoices(timeout=1500){
      return new Promise(resolve=>{
        const have = speechSynthesis.getVoices?.();
        if (have && have.length) return resolve(have);
        const t = setTimeout(()=> resolve(speechSynthesis.getVoices?.()||[]), timeout);
        speechSynthesis.onvoiceschanged = ()=>{ clearTimeout(t); resolve(speechSynthesis.getVoices?.()||[]); };
      });
    }
    function getKoreanVoices(all){
      return (all||[]).filter(v=>{
        const n=(v.name||'').toLowerCase(), l=(v.lang||'').toLowerCase();
        return l.startsWith('ko') || n.includes('korean') || n.includes('한국') || n.includes('korea');
      });
    }
    function presetsForSingleVoice(){
      return [
        {id:'preset-soft-low',  label:'프리셋 · 저음/느림',   rate:0.85, pitch:0.85},
        {id:'preset-soft-high', label:'프리셋 · 고음/느림',   rate:0.90, pitch:1.20},
        {id:'preset-fast',      label:'프리셋 · 빠름',       rate:1.20, pitch:1.05},
        {id:'preset-bright',    label:'프리셋 · 밝게',       rate:1.05, pitch:1.25},
        {id:'preset-radio',     label:'프리셋 · 라디오톤',   rate:1.00, pitch:0.90},
        {id:'preset-reading',   label:'프리셋 · 낭독체',     rate:0.95, pitch:1.00},
      ];
    }
    async function setupVoices(){
      const all = await waitForVoices();
      const kos = getKoreanVoices(all);

      voiceSelect.innerHTML = '';
      const def = document.createElement('option');
      def.value = JSON.stringify({type:'default'});
      def.textContent = '브라우저 기본(ko-KR)';
      voiceSelect.appendChild(def);

      if(kos.length > 0){
        const og = document.createElement('optgroup'); og.label = '한국어 보이스';
        kos.forEach(v=>{
          const opt = document.createElement('option');
          opt.value = JSON.stringify({type:'voice', uri:v.voiceURI});
          opt.textContent = `${v.name} — ${v.lang}${v.localService ? ' (로컬)' : ''}`;
          og.appendChild(opt);
        });
        voiceSelect.appendChild(og);
      }
      if(kos.length <= 1){
        const pg = document.createElement('optgroup'); pg.label = '스타일 프리셋';
        presetsForSingleVoice().forEach(p=>{
          const opt = document.createElement('option');
          opt.value = JSON.stringify({type:'preset', rate:p.rate, pitch:p.pitch});
          opt.textContent = p.label;
          pg.appendChild(opt);
        });
        voiceHint.style.display = '';
      } else {
        voiceHint.style.display = 'none';
      }

      const saved = localStorage.getItem(VOICE_CHOICE_KEY);
      if(saved){
        const idx = [...voiceSelect.options].findIndex(o=>o.value===saved);
        if(idx>=0) voiceSelect.selectedIndex = idx;
      } else {
        localStorage.setItem(VOICE_CHOICE_KEY, voiceSelect.value);
      }
      voiceSelect.addEventListener('change', ()=> localStorage.setItem(VOICE_CHOICE_KEY, voiceSelect.value));
      testVoiceBtn.onclick = ()=> speakSample('태초에 하나님이 천지를 창조하시니라.');
    }
    function resolveVoiceChoice(){
      try{ return JSON.parse(localStorage.getItem(VOICE_CHOICE_KEY)||'{"type":"default"}'); }
      catch{ return {type:'default'}; }
    }
    function pickVoiceByURI(uri){ return (speechSynthesis.getVoices?.()||[]).find(v=>v.voiceURI===uri) || null; }
    function applyVoice(u){
      const choice = resolveVoiceChoice();
      const baseRate = parseFloat(rateCtl.value||'0.95');
      const basePitch = parseFloat(pitchCtl.value||'1');
      if(choice.type==='voice'){
        const v = pickVoiceByURI(choice.uri);
        if(v){ u.voice = v; u.lang = v.lang; } else { u.lang = 'ko-KR'; }
        u.rate = baseRate; u.pitch = basePitch;
      } else if(choice.type==='preset'){
        u.lang = 'ko-KR';
        u.rate = clamp((choice.rate ?? 0.95) * baseRate / 0.95, 0.5, 2);
        u.pitch = clamp((choice.pitch ?? 1.0) * basePitch / 1.0, 0, 2);
      } else {
        u.lang = 'ko-KR'; u.rate = baseRate; u.pitch = basePitch;
      }
    }
    function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
    function speakSample(text){
      const synth = window.speechSynthesis;
      try{ synth.cancel(); }catch(e){}
      const u = new SpeechSynthesisUtterance(text);
      applyVoice(u);
      synth.speak(u);
    }

    /* --------- kind → storage key --------- */
    function getCtxStorageKey(kind){
      switch((kind||'').trim()){
        case 'unit':       return STORAGE_UNIT_CTX;
        case 'whole':      return STORAGE_WHOLE_CTX;
        case 'commentary': return STORAGE_COMMENTARY; // 주석
        case 'summary':    return STORAGE_SUMMARY;    // 요약
        default:           return null;
      }
    }

    /* --------- Tree --------- */
    function buildTree(){
      treeEl.innerHTML = '';
      if(!BIBLE){ treeEl.innerHTML = '<div class="muted">파일을 찾을 수 없습니다.</div>'; return; }

      for(const bookName of Object.keys(BIBLE.books)){
        const detBook = document.createElement('details');
        const sumBook = document.createElement('summary');
        sumBook.innerHTML = `<span class="tw">${escapeHtml(bookName)}</span>`;
        detBook.appendChild(sumBook);

        const chWrap = document.createElement('div'); chWrap.className='chapters';
        const chapters = Object.keys(BIBLE.books[bookName]).map(n=>parseInt(n,10)).sort((a,b)=>a-b);

        for(const ch of chapters){
          const detChap = document.createElement('details');
          const sumChap = document.createElement('summary');
          sumChap.innerHTML = `<span class="chip">${ch}장</span>`;
          detChap.appendChild(sumChap);

          const parWrap = document.createElement('div'); parWrap.className='paras';
          const paras = BIBLE.books[bookName][ch].paras || [];
          paras.forEach((p, idx)=>{
            const detPara = document.createElement('details'); detPara.className='para';

            const m = String(p.ref||'').match(/^(\d+):(\d+)(?:-(\d+))?$/);
            const v1 = m ? m[2] : '?', v2 = m ? (m[3]||m[2]) : '?';
            const titleText = p.title || p.ref;

            const sum = document.createElement('summary');
            sum.innerHTML = `
              <span class="vrange">(${v1}-${v2})</span>
              <span class="ptitle"
                    data-book="${bookName}"
                    data-ch="${ch}"
                    data-idx="${idx}"
                    title="제목을 더블클릭하면 편집할 수 있습니다">${escapeHtml(titleText)}</span>
            `;

            const titleEl = sum.querySelector('.ptitle');

            // 더블클릭 시 인라인 편집, summary 토글 방지
            titleEl.addEventListener('dblclick', (e)=>{
              e.preventDefault(); e.stopPropagation();
              detPara.open = true;
              startInlineTitleEdit(titleEl, bookName, ch, idx);
            }, true);

            // summary 자체에서도 타이틀 더블클릭/편집중 토글 방지
            function guardSummary(ev){
              const isEditing = titleEl.isContentEditable;
              const dblOnTitle = (ev.type === 'dblclick' && ev.target === titleEl);
              if (isEditing || dblOnTitle){
                ev.preventDefault();
                ev.stopPropagation();
              }
            }
            ['pointerdown','mousedown','click','dblclick'].forEach(type=>{
              sum.addEventListener(type, guardSummary, true);
            });

            detPara.appendChild(sum);

            const body = document.createElement('div');
            body.className = 'pbody';
            body.innerHTML = `
              <div class="ptoolbar">
                <button class="primary speakBtn">낭독</button>
                <label class="chip"><input type="checkbox" class="keepReading" style="margin-right:6px">계속 낭독</label>
                <button class="ctxBtn btnUnitCtx">단위성경속 맥락</button>
                <button class="ctxBtn btnWholeCtx">전체성경속 맥락</button>
                <button class="ctxBtn btnCommentary">주석</button>
                <button class="ctxBtn btnSummary">내용요약</button>
                <div class="spacer"></div>
                <button class="sermBtn">설교</button>
              </div>
              <div class="pcontent"></div>`;
            detPara.appendChild(body);

            const pcontent = body.querySelector('.pcontent');
            (p.verses||[]).forEach(([v,t])=>{
              const line = document.createElement('div');
              line.className = 'pline';
              line.dataset.verse = v;
              line.innerHTML = `<sup class="pv">${v}</sup>${t}`;
              pcontent.appendChild(line);
            });

            detPara.addEventListener('toggle', ()=>{
              if(detPara.open){
                CURRENT.book = bookName; CURRENT.chap = ch; CURRENT.paraIdx = idx;
                const para = BIBLE.books[bookName][ch].paras[idx];
                CURRENT.paraId = `${bookName}|${ch}|${para.ref}`;
                status(`선택됨: ${bookName} ${ch}장 · ${para.title||para.ref}`);
              }
            });

            body.querySelector('.speakBtn').addEventListener('click', ()=>{
              toggleSpeakInline(bookName, ch, idx, detPara, body.querySelector('.speakBtn'));
            });
            body.querySelector('.sermBtn').addEventListener('click', ()=>{
              CURRENT.book = bookName; CURRENT.chap = ch; CURRENT.paraIdx = idx;
              const para = BIBLE.books[bookName][ch].paras[idx];
              CURRENT.paraId = `${bookName}|${ch}|${para.ref}`;
              openSermonModal();
            });
            body.querySelector('.btnUnitCtx').addEventListener('click', ()=>{ CURRENT.book=bookName; CURRENT.chap=ch; CURRENT.paraIdx=idx; openSingleDocEditor('unit'); });
            body.querySelector('.btnWholeCtx').addEventListener('click',()=>{ CURRENT.book=bookName; CURRENT.chap=ch; CURRENT.paraIdx=idx; openSingleDocEditor('whole'); });
            body.querySelector('.btnCommentary').addEventListener('click',()=>{ CURRENT.book=bookName; CURRENT.chap=ch; CURRENT.paraIdx=idx; openSingleDocEditor('commentary'); });
            body.querySelector('.btnSummary').addEventListener('click',   ()=>{ CURRENT.book=bookName; CURRENT.chap=ch; CURRENT.paraIdx=idx; openSingleDocEditor('summary'); });

            parWrap.appendChild(detPara);
          });

          detChap.appendChild(parWrap);
          chWrap.appendChild(detChap);
        }

        detBook.appendChild(chWrap);
        treeEl.appendChild(detBook);
      }
    }

    /* --------- Inline TTS --------- */
    function buildQueueFrom(book, chap, idx){
      const para = BIBLE.books[book][chap].paras[idx];
      return (para.verses||[]).map(([v,t])=>({verse:v, text:t}));
    }
    function clearReadingHighlight(scope){ [...scope.querySelectorAll('.pline')].forEach(el=> el.classList.remove('reading')); }
    function bindKeepReading(scope){
      const cb = scope.querySelector('.keepReading');
      if(!cb) return; cb.checked = READER.continuous; cb.onchange = ()=> { READER.continuous = cb.checked; };
    }
    function speakVerseItemInScope(item, scope, onend){
      if(!READER.synth) return;
      const u = new SpeechSynthesisUtterance(String(item.text));
      applyVoice(u);
      u.onstart = ()=>{
        clearReadingHighlight(scope);
        const line = scope.querySelector(`.pline[data-verse="${item.verse}"]`);
        if(line){ line.classList.add('reading'); line.scrollIntoView({block:'center', behavior:'smooth'}); }
      };
      u.onend = onend;
      READER.synth.speak(u);
    }
    function toggleSpeakInline(book, chap, idx, paraDetailsEl, btnEl){
      if(!READER.synth) return alert('이 브라우저는 음성합성을 지원하지 않습니다.');
      const sameScope = READER.playing && READER.scope === paraDetailsEl;
      if(READER.playing && sameScope){ stopSpeakInline(); return; }

      const cb = paraDetailsEl.querySelector('.keepReading');
      READER.continuous = !!(cb && cb.checked);

      READER.q = buildQueueFrom(book, chap, idx);
      READER.idx = 0; READER.playing = true; READER.scope = paraDetailsEl; READER.btn = btnEl;
      bindKeepReading(READER.scope); updateInlineSpeakBtn(); playNextInQueueInline(book, chap, idx);
    }
    function playNextInQueueInline(book, chap, idx){
      if(!READER.playing) return;
      if(READER.idx >= READER.q.length){
        if(READER.continuous && goToNextParagraphInline(book, chap, idx)){
          READER.q = buildQueueFrom(CURRENT.book, CURRENT.chap, CURRENT.paraIdx);
          READER.idx = 0; bindKeepReading(READER.scope);
          playNextInQueueInline(CURRENT.book, CURRENT.chap, CURRENT.paraIdx);
          return;
        }
        stopSpeakInline(); return;
      }
      const item = READER.q[READER.idx];
      speakVerseItemInScope(item, READER.scope, ()=>{ READER.idx++; playNextInQueueInline(book, chap, idx); });
    }
    function stopSpeakInline(){
      READER.playing = false;
      try{ READER.synth && READER.synth.cancel(); }catch(e){}
      if(READER.scope) clearReadingHighlight(READER.scope);
      updateInlineSpeakBtn(); READER.scope = null; READER.btn = null;
    }
    function updateInlineSpeakBtn(){ if(READER.btn) READER.btn.textContent = READER.playing ? '중지' : '낭독'; }

    function goToNextParagraphInline(book, chap, idx){
      const chObj = BIBLE.books[book][chap];

      const booksEls = [...treeEl.children];
      const bIdx = Object.keys(BIBLE.books).indexOf(book);
      const bookEl = booksEls[bIdx]; if(!bookEl) return false;

      const chaptersEls = bookEl.querySelectorAll(':scope > .chapters > details');
      const chapNums = Object.keys(BIBLE.books[book]).map(n=>parseInt(n,10)).sort((a,b)=>a-b);
      const chPos = chapNums.indexOf(ch);
      const chapEl = chaptersEls[chPos]; if(!chapEl) return false;

      const paraEls = chapEl.querySelectorAll(':scope > .paras > details.para');

      if(idx < chObj.paras.length-1){
        const nextEl = paraEls[idx+1];
        if(nextEl){
          chapEl.open = true; nextEl.open = true;
          CURRENT.book = book; CURRENT.chap = chap; CURRENT.paraIdx = idx+1;
          READER.scope = nextEl; READER.btn = nextEl.querySelector('.speakBtn');
          return true;
        }
      }
      if(chPos >= 0 && chPos < chapNums.length-1){
        const nextChap = chapNums[chPos+1];
        const nextChapEl = chaptersEls[chPos+1];
        if(nextChapEl){
          const nextParas = BIBLE.books[book][nextChap].paras||[];
          if(nextParas.length){
            const nextParaEl = nextChapEl.querySelector(':scope > .paras > details.para');
            nextChapEl.open = true; if(nextParaEl) nextParaEl.open = true;
            CURRENT.book = book; CURRENT.chap = nextChap; CURRENT.paraIdx = 0;
            READER.scope = nextParaEl; READER.btn = nextParaEl?.querySelector('.speakBtn') || null;
            return true;
          }
        }
      }
      const bookNames = Object.keys(BIBLE.books);
      const bPos = bookNames.indexOf(book);
      if(bPos >= 0 && bPos < bookNames.length-1){
        const nextBook = bookNames[bPos+1];
        const nextBookEl = booksEls[bPos+1];
        if(nextBookEl){
          const firstChap = Math.min(...Object.keys(BIBLE.books[nextBook]).map(n=>parseInt(n,10)));
          const nextChapEl = nextBookEl.querySelector(':scope > .chapters > details');
          const nextParaEl = nextChapEl?.querySelector(':scope > .paras > details.para');
          if(nextParaEl){
            nextBookEl.open = true; nextChapEl.open = true; nextParaEl.open = true;
            CURRENT.book = nextBook; CURRENT.chap = firstChap; CURRENT.paraIdx = 0;
            READER.scope = nextParaEl; READER.btn = nextParaEl.querySelector('.speakBtn');
            return true;
          }
        }
      }
      return false;
    }

    /* --------- Sermon / Context Editors --------- */
    function getSermonMap(){ try{ return JSON.parse(localStorage.getItem(STORAGE_SERMON)||'{}'); }catch{ return {}; } }
    function setSermonMap(o){ localStorage.setItem(STORAGE_SERMON, JSON.stringify(o)); }
    function getDocMap(storageKey){ try{ return JSON.parse(localStorage.getItem(storageKey)||'{}'); }catch{ return {}; } }
    function setDocMap(storageKey, obj){ localStorage.setItem(storageKey, JSON.stringify(obj)); }

    function openSermonModal(){
      if(!CURRENT.paraId){ const openPara = treeEl.querySelector('details.para[open]'); if(!openPara) return; }
      const para = BIBLE.books[CURRENT.book][CURRENT.chap].paras[CURRENT.paraIdx];
      modalRef.textContent = `${CURRENT.book} ${CURRENT.chap}장 · ${para.title||para.ref} (${para.ref})`;
      renderSermonList();
      sermonEditor.style.display = 'none';
      modalWrap.style.display = 'flex';
      modalWrap.setAttribute('aria-hidden','false');
      modalFooterNew.style.display = '';
    }
    el('closeModal').onclick = ()=>{ modalWrap.style.display='none'; modalWrap.setAttribute('aria-hidden','true'); stopEditorSpeak(true); };

    // kind: 'unit' | 'whole' | 'commentary' | 'summary'
    function openSingleDocEditor(kind){
      const para = BIBLE.books[CURRENT.book][CURRENT.chap].paras[CURRENT.paraIdx];
      const pid  = `${CURRENT.book}|${CURRENT.chap}|${para.ref}`;

      const titlePrefix =
        kind==='unit'       ? '단위성경속 맥락' :
        kind==='whole'      ? '전체성경속 맥락' :
        kind==='commentary' ? '주석' :
                              '내용요약';

      const storageKey = getCtxStorageKey(kind);
      const map = getDocMap(storageKey);
      let doc = map[pid] || {
        title: `${titlePrefix} — ${para.title||para.ref}`,
        body:  (kind==='summary' ? '핵심 내용을 간결하게 요약해 적어주세요.' : ''),
        images: [], date:''
      };

      // 과거에 잘못 들어간 제목 교정(주석 화면에 ‘내용요약 — …’가 보일 때)
      if (kind==='commentary' && /^내용요약\s*—\s*/.test(doc.title||'')){
        doc.title = doc.title.replace(/^내용요약\s*—\s*/, '주석 — ');
      }

      modalRef.textContent = `${CURRENT.book} ${CURRENT.chap}장 · ${para.title||para.ref} (${para.ref}) — ${titlePrefix}`;
      sermonList.innerHTML = '';
      sermonEditor.style.display = '';
      modalWrap.style.display = 'flex';
      modalWrap.setAttribute('aria-hidden','false');
      modalFooterNew.style.display = 'none';

      sermonTitle.value = doc.title || '';
      sermonBody.value  = doc.body  || '';
      sermonThumbs.innerHTML = '';
      (doc.images||[]).forEach(src=>{ const img=new Image(); img.src=src; sermonThumbs.appendChild(img); });

      sermonEditor.dataset.editing = '';
      sermonEditor.dataset.ctxType = kind;

      // 주석/요약/맥락 문서 삭제 버튼 표시/바인딩
      const delBtn = document.getElementById('deleteCtxDoc');
      if (delBtn){
        delBtn.style.display = '';
        delBtn.onclick = ()=>{
          const key = getCtxStorageKey(sermonEditor.dataset.ctxType||'');
          if(!key) return;
          const m = getDocMap(key);
          if(!m[pid]){ alert('삭제할 문서가 없습니다.'); return; }
          if(!confirm('이 문서를 삭제할까요?')) return;
          delete m[pid]; setDocMap(key, m);
          sermonEditor.dataset.ctxType = '';
          modalWrap.style.display = 'none';
          modalWrap.setAttribute('aria-hidden','true');
          status(`${titlePrefix} 문서를 삭제했습니다.`);
        };
      }
    }

    function renderSermonList(){
      const map = getSermonMap();
      const arr = map[CURRENT.paraId] || [];
      sermonList.innerHTML = '';
      if(arr.length===0){ startNewSermon(); return; }

      arr.forEach((it, idx)=>{
        const row = document.createElement('div'); row.className='item';
        const dateHtml = it.date ? `<span class="date">${it.date}</span>` : '';
        row.innerHTML = `
          <div class="item-title">
            ${escapeHtml(it.title||'(제목 없음)')} ${dateHtml}
          </div>
          <div class="ptoolbar">
            <button data-edit="${idx}">편집</button>
            <button data-del="${idx}" style="border-color:var(--danger);color:var(--text)">삭제</button>
          </div>`;
        row.querySelector('[data-edit]').onclick = ()=>{
          modalWrap.style.display = 'none'; modalWrap.setAttribute('aria-hidden','true');
          openSermonEditorWindow(idx);
        };
        row.querySelector('[data-del]').onclick = ()=> deleteSermon(idx);
        sermonList.appendChild(row);
      });
    }

    el('newSermonBtn').onclick = ()=>{
      if (sermonEditor.dataset.ctxType) return; // 컨텍스트 편집 중에는 차단
      const map = getSermonMap();
      const arr = map[CURRENT.paraId] || [];
      arr.unshift({ id: crypto.randomUUID(), title:'', body:'', images:[], date:'' });
      map[CURRENT.paraId] = arr; setSermonMap(map);

      modalWrap.style.display='none'; modalWrap.setAttribute('aria-hidden','true');
      openSermonEditorWindow(0);
    };

    function startNewSermon(){
      sermonList.innerHTML = '<div class="muted" style="padding:0 14px">새 설교를 작성해 저장하면 이 단락에 붙습니다.</div>';
      sermonEditor.style.display = '';
      sermonTitle.value = ''; sermonBody.value = ''; sermonThumbs.innerHTML = ''; sermonImages.value = '';
      sermonEditor.dataset.editing = '';
      stopEditorSpeak(true);
    }
    function editSermon(idx){
      const map = getSermonMap(); const arr = map[CURRENT.paraId] || []; const it = arr[idx]; if(!it) return;
      sermonEditor.style.display = ''; sermonEditor.dataset.editing = String(idx);
      sermonTitle.value = it.title||''; sermonBody.value = it.body||''; sermonThumbs.innerHTML = '';
      (it.images||[]).forEach(src=>{ const img=new Image(); img.src=src; sermonThumbs.appendChild(img); });
      stopEditorSpeak(true);
    }
    function deleteSermon(idx){
      if(!confirm('이 설교를 삭제할까요?')) return;
      const map = getSermonMap(); const arr = map[CURRENT.paraId] || [];
      arr.splice(idx,1); map[CURRENT.paraId] = arr; setSermonMap(map); renderSermonList();
    }

    el('cancelEdit').onclick = ()=>{
      if(sermonEditor.dataset.ctxType){
        sermonEditor.dataset.ctxType = '';
        modalWrap.style.display = 'none'; modalWrap.setAttribute('aria-hidden','true');
      }else{
        sermonEditor.style.display = 'none'; renderSermonList();
      }
      stopEditorSpeak(true);
    };

    // 저장 핸들러(컨텍스트/설교 모두 처리)
    el('saveSermon').onclick = ()=>{
      const title = sermonTitle.value.trim() || '(제목 없음)';
      const body  = sermonBody.value.trim();
      const imgs  = [...sermonThumbs.querySelectorAll('img')].map(img=>img.src);
      const date  = todayStr();

      const para  = BIBLE.books[CURRENT.book][CURRENT.chap].paras[CURRENT.paraIdx];
      const pid   = `${CURRENT.book}|${CURRENT.chap}|${para.ref}`;

      // 컨텍스트 문서 저장(주석/요약/맥락)
      const ctxType    = (sermonEditor.dataset.ctxType || '').trim();
      const storageKey = getCtxStorageKey(ctxType);

      if(storageKey){
        const map = getDocMap(storageKey);
        map[pid] = { title, body, images: imgs, date };
        setDocMap(storageKey, map);

        sermonEditor.dataset.ctxType = '';
        modalWrap.style.display = 'none';
        modalWrap.setAttribute('aria-hidden','true');

        status(`저장됨: [${ctxType==='commentary' ? '주석' :
                          ctxType==='summary'    ? '내용요약' :
                          ctxType==='unit'       ? '단위성경속 맥락' :
                                                   '전체성경속 맥락'}] ${title}`);
        return;
      }

      // 일반 설교 저장
      const map = getSermonMap();
      const arr = map[CURRENT.paraId] || [];
      const editing = sermonEditor.dataset.editing;

      if(editing!==''){
        const i = +editing;
        if(arr[i]) arr[i] = {...arr[i], title, body, images: imgs, date};
      }else{
        arr.unshift({ id: crypto.randomUUID(), title, body, images: imgs, date });
      }
      map[CURRENT.paraId] = arr; setSermonMap(map);

      sermonEditor.style.display = 'none';
      renderSermonList();
      status('설교가 저장되었습니다.');
    };

    sermonImages.addEventListener('change', async ()=>{
      const files = [...sermonImages.files||[]];
      for(const f of files){ const data = await fileToDataURL(f); const img = new Image(); img.src = data; sermonThumbs.appendChild(img); }
      sermonImages.value = '';
    });

    /* --------- Editor TTS --------- */
    editorSpeakBtn.onclick = ()=> toggleEditorSpeak();
    function toggleEditorSpeak(){
      if(!EDITOR_READER.synth) return alert('이 브라우저는 음성합성을 지원하지 않습니다.');
      if(EDITOR_READER.playing){ stopEditorSpeak(); return; }
      const text = [sermonTitle.value.trim(), sermonBody.value.trim()].filter(Boolean).join('. ');
      if(!text){ alert('낭독할 내용이 없습니다.'); return; }
      const u = new SpeechSynthesisUtterance(text.replace(/\n{2,}/g, '. ').replace(/\n/g,' '));
      applyVoice(u); u.onend = ()=> stopEditorSpeak(true);
      EDITOR_READER.u = u; EDITOR_READER.synth.cancel(); EDITOR_READER.synth.speak(u);
      EDITOR_READER.playing = true; editorSpeakBtn.textContent = '중지';
    }
    function stopEditorSpeak(silent){
      if(EDITOR_READER.synth){ try{ EDITOR_READER.synth.cancel(); }catch(e){} }
      EDITOR_READER.playing = false; EDITOR_READER.u = null;
      if(!silent) status('설교 낭독을 중지했습니다.'); editorSpeakBtn.textContent = '낭독';
    }

    /* --------- Misc --------- */
    window.addEventListener('keydown', (e)=>{
      if(e.target && ['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
      if(e.key.toLowerCase()==='s'){ e.preventDefault();
        const openPara = treeEl.querySelector('details.para[open]');
        if(openPara && CURRENT.book!=null){
          const btn = openPara.querySelector('.speakBtn');
          toggleSpeakInline(CURRENT.book, CURRENT.chap, CURRENT.paraIdx, openPara, btn);
        }
      }
      if(e.key.toLowerCase()==='n'){ e.preventDefault();
        if(CURRENT.book!=null){ READER.playing=false; if(READER.synth) READER.synth.cancel(); goToNextParagraphInline(CURRENT.book, CURRENT.chap, CURRENT.paraIdx); }
      }
    });

    // Ctrl+Shift+S → 현재 메모리 BIBLE을 JSON으로 다운로드
    window.addEventListener('keydown', (e)=>{
      if(e.ctrlKey && e.shiftKey && e.key.toLowerCase()==='s'){
        e.preventDefault();
        downloadBibleJSON();
      }
    });

    /* --------- Sermon Editor Popup (Slim) --------- */
    /* --------- Sermon Editor Popup (Beauty, Complete) --------- */
    function openSermonEditorWindow(idx){
      const map = getSermonMap();
      const arr = map[CURRENT.paraId] || [];
      const it  = arr[idx];
      if(!it){ alert('편집할 설교를 찾을 수 없습니다.'); return; }
    
      const meta = {
        paraId: CURRENT.paraId,
        ref: `${CURRENT.book} ${CURRENT.chap}장`,
        title: it.title || '',
        body:  it.body  || '',
        images: it.images || [],
        date: it.date || ''
      };
    
      const w = window.open('', '_blank', 'width=1100,height=800');
      if(!w){ alert('팝업이 차단되었습니다. 브라우저 팝업을 허용해주세요.'); return; }
    
      // ==== 팝업 문서 작성 ====
      w.document.open();
      w.document.write(`<!DOCTYPE html><html lang="ko">
    <head>
      <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
      <title>설교 편집</title>
      <style>
        :root{
          --bg:#0f1115; --panel:#161922; --text:#e9ecf3; --muted:#9aa0ab;
          --edge:#242a38; --accent:#7fb4ff; --accent-2:#4ea1ff; --danger:#ff6b6b;
          --shadow:0 10px 30px rgba(0,0,0,.35);
        }
        *{ box-sizing:border-box } html,body{ height:100% }
        body{
          margin:0; background:var(--bg); color:var(--text);
          font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
          display:grid; grid-template-rows:auto 1fr auto; gap:12px;
        }
        header,footer{
          background:linear-gradient(180deg, color-mix(in srgb,var(--panel) 92%, #000 0%), color-mix(in srgb,var(--panel) 76%, #000 8%));
          border:1px solid var(--edge); box-shadow:var(--shadow);
          margin:12px; border-radius:14px; padding:10px 12px; display:flex; align-items:center; gap:10px;
        }
        header .title{ font-weight:800; font-size:14px;
          background:linear-gradient(90deg,var(--accent),#c8e1ff);
          -webkit-background-clip:text; background-clip:text; color:transparent;
        }
        header .ref{ color:var(--muted); font-size:13px } header .dot{ opacity:.35 }
        main{ padding:0 12px 12px }
        .card{ background:var(--panel); border:1px solid var(--edge); border-radius:16px; box-shadow:var(--shadow); padding:16px; display:grid; gap:14px; }
        .field{ display:grid; gap:8px } .label{ color:var(--muted); font-size:12px }
        .input,.textarea{
          width:100%; background:#12151d; color:var(--text);
          border:1px solid color-mix(in srgb, var(--edge) 80%, #000 20%);
          border-radius:12px; padding:12px 14px; outline:none;
          transition:border-color .15s, box-shadow .15s;
        }
        .input:focus,.textarea:focus{
          border-color: color-mix(in srgb, var(--accent) 60%, #000 20%);
          box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 25%, transparent 75%);
        }
        .input.title{ font-size:18px; font-weight:800; padding:14px 16px; letter-spacing:.2px; }
        .textarea{ min-height:46vh; line-height:1.65; border-radius:14px; resize:vertical; font-size:15px; }
        .toolbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between; }
        .left,.right{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
        .chip{ padding:6px 10px; border:1px solid var(--edge); border-radius:999px; color:var(--muted);
               background:color-mix(in srgb, var(--panel) 86%, #000 6%); font-size:12px; }
        .count{ color:var(--muted); font-size:12px }
        .thumbs{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px }
        .thumb{ position:relative; width:108px; height:108px; border-radius:12px; overflow:hidden; border:1px solid var(--edge); background:#0b0e14; }
        .thumb img{ width:100%; height:100%; object-fit:cover; display:block }
        .thumb button{ position:absolute; inset:auto 6px 6px auto; border:1px solid var(--edge);
                       background:rgba(0,0,0,.55); color:#ffd9d9; cursor:pointer; padding:4px 7px; border-radius:8px; font-size:12px; }
        .btn{ background:color-mix(in srgb, var(--panel) 70%, #000 12%); color:var(--text);
              border:1px solid var(--edge); border-radius:12px; padding:10px 14px; cursor:pointer; transition:border-color .15s, transform .02s; }
        .btn:hover{ border-color:color-mix(in srgb, var(--accent) 40%, var(--edge) 60%) } .btn:active{ transform:translateY(1px) }
        .btn.primary{ background:linear-gradient(180deg, color-mix(in srgb, var(--accent) 78%, #fff 6%), color-mix(in srgb, #4ea1ff 80%, #000 15%));
                      border-color:color-mix(in srgb, #4ea1ff 65%, #000 15%); color:#0b1220; font-weight:800; }
        .btn.danger{ border-color:var(--danger); color:#ffdede; background:transparent }
        .grow{ flex:1 1 auto } footer .hint{ color:var(--muted); font-size:12px }
        @media (max-width:680px){ .textarea{ min-height:38vh } header,footer{ margin:10px } .btn{ padding:9px 12px } }
      </style>
    </head>
    <body>
      <header>
        <div class="title">설교 편집</div><span class="dot">•</span><span class="ref" id="ref"></span>
        <div class="grow"></div><button class="btn" id="x">닫기(ESC)</button>
      </header>
    
      <main>
        <div class="card">
          <div class="field">
            <div class="label">제목</div>
            <input id="t" class="input title" placeholder="설교 제목" />
          </div>
    
          <div class="toolbar">
            <div class="left">
              <label class="btn">이미지 추가 <input type="file" id="imgs" accept="image/*" multiple style="display:none"></label>
              <span class="chip" id="date"></span>
            </div>
            <div class="right"><span class="count" id="counter">0자 · 0단어</span></div>
          </div>
    
          <textarea id="b" class="textarea" placeholder="설교 본문을 입력하세요. (Ctrl+S 저장)"></textarea>
          <div class="thumbs" id="th"></div>
        </div>
      </main>
    
      <footer>
        <span class="hint">단축키: <b>Ctrl+S</b> 저장 · <b>Esc</b> 닫기</span>
        <div class="grow"></div>
        <button class="btn danger" id="d">삭제</button>
        <button class="btn primary" id="s">저장</button>
      </footer>
    
      <script>
        // === 초기 데이터 ===
        const meta = ${JSON.stringify(meta)};
        const t = document.getElementById('t'), b = document.getElementById('b'), th = document.getElementById('th');
        const imgs = document.getElementById('imgs'), ref = document.getElementById('ref'), date = document.getElementById('date');
        const sBtn = document.getElementById('s'), dBtn = document.getElementById('d'), xBtn = document.getElementById('x'), counter = document.getElementById('counter');
    
        ref.textContent = meta.ref || ''; date.textContent = meta.date ? ('최근 저장: ' + meta.date) : '';
        t.value = meta.title || ''; b.value = meta.body || ''; (meta.images||[]).forEach(src=> addThumb(src));
    
        function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
        function addThumb(src){ const w=document.createElement('div'); w.className='thumb'; w.innerHTML='<img><button type="button">삭제</button>'; w.querySelector('img').src=src; w.querySelector('button').onclick=()=>w.remove(); th.appendChild(w); }
        function collectImages(){ return [...th.querySelectorAll('img')].map(i=>i.src); }
    
        imgs.addEventListener('change', async ()=>{ for(const f of [...imgs.files||[]]) addThumb(await fileToDataURL(f)); imgs.value=''; });
    
        function updateCounter(){ const text=(b.value||'').trim(); const chars=text.length; const words=text?text.split(/\\s+/).length:0; counter.textContent=chars+'자 · '+words+'단어'; }
        b.addEventListener('input', updateCounter); updateCounter();
    
        function doSave(){
          opener.postMessage({ type:'sermon-save',
            title:(t.value||'').trim()||'(제목 없음)',
            body:(b.value||'').trim(), images:collectImages()
          }, '*'); window.close();
        }
        function doDelete(){ if(confirm('이 설교를 삭제할까요?')){ opener.postMessage({ type:'sermon-delete' }, '*'); window.close(); } }
    
        sBtn.addEventListener('click', doSave); dBtn.addEventListener('click', doDelete); xBtn.addEventListener('click', ()=>window.close());
        window.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); doSave(); } if(e.key==='Escape'){ e.preventDefault(); window.close(); } });
      <\/script>
    </body>
    </html>`);
      w.document.close();
    
      // ==== 부모창 메시지 수신 (이 팝업에서 오는 것만 처리) ====
      const onMsg = (ev) => {
        // file://에서도 동작하도록 origin 체크는 완화, 그래도 타입 필수
        const data = ev?.data || {};
        if(!data.type) return;
    
        const map = getSermonMap();
        const arr = map[CURRENT.paraId] || [];
    
        if(data.type === 'sermon-save'){
          const now = new Date();
          const date = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
          if(arr[idx]){
            arr[idx] = { ...arr[idx], title: data.title, body: data.body, images: data.images, date };
          }
          map[CURRENT.paraId] = arr; setSermonMap(map);
          status('설교가 저장되었습니다.');
          renderSermonList();
          window.removeEventListener('message', onMsg); // 정리
        }
    
        if(data.type === 'sermon-delete'){
          if(arr[idx]) arr.splice(idx, 1);
          map[CURRENT.paraId] = arr; setSermonMap(map);
          status('설교가 삭제되었습니다.');
          renderSermonList();
          window.removeEventListener('message', onMsg); // 정리
        }
      };
      window.addEventListener('message', onMsg);
    }

  </script>
</body>
</html>
